<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Recipes | Knex.js</title>
    <meta name="description" content="Beta knex.js documentation.">
    <link rel="stylesheet" href="/assets/style.a21b8e16.css">
    <link rel="modulepreload" href="/assets/chunks/AlgoliaSearchBox.a88cc1e3.js">
    <link rel="modulepreload" href="/assets/chunks/AlgoliaSearchBox.639416b3.js">
    <link rel="modulepreload" href="/assets/app.36cb52e5.js">
    <link rel="modulepreload" href="/assets/faq_recipes.md.9519710b.lean.js">
    
    <link rel="icon" type="image/png" href="/knex-logo.png">
  <meta name="twitter:title" content="Recipes | Knex.js">
  <meta property="og:title" content="Recipes | Knex.js">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="Knex.js, back to home" data-v-675d8756 data-v-cc01ef16><img class="logo" src="/knex-logo.png" alt="Logo" data-v-cc01ef16> Knex.js</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/guide/" data-v-b8818f8c>Guide <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/faq/" data-v-b8818f8c>F.A.Q. <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/changelog.html" data-v-b8818f8c>Changelog <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/knex/knex" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--[--><select class="sql-dropdown item nav-link"><option value="mysql" selected>MySQL / MariaDB</option><option value="mysql2">MySQL2</option><option value="postgres">PostgreSQL</option><option value="pgnative">PG Native</option><option value="cockroachdb">CockroachDB</option><option value="redshift">Amazon Redshift</option><option value="sqlite3">SQLite3</option><option value="oracledb">OracleDB</option><option value="mssql">MSSQL</option></select><div class="algolia-search-box" id="docsearch"></div><a class="toggle-dark" tabindex="0" role="button" data-v-2a5e0da6><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 256" data-v-2a5e0da6><circle cx="128" cy="128" r="60" fill="currentColor" opacity=".2" data-v-2a5e0da6></circle><path fill="currentColor" d="M128 60a68 68 0 1 0 68 68a68.1 68.1 0 0 0-68-68Zm0 120a52 52 0 1 1 52-52a52 52 0 0 1-52 52Zm-8-144V16a8 8 0 0 1 16 0v20a8 8 0 0 1-16 0ZM43.1 54.5a8.1 8.1 0 1 1 11.4-11.4l14.1 14.2a8 8 0 0 1 0 11.3a8.1 8.1 0 0 1-11.3 0ZM36 136H16a8 8 0 0 1 0-16h20a8 8 0 0 1 0 16Zm32.6 51.4a8 8 0 0 1 0 11.3l-14.1 14.2a8.3 8.3 0 0 1-5.7 2.3a8.5 8.5 0 0 1-5.7-2.3a8.1 8.1 0 0 1 0-11.4l14.2-14.1a8 8 0 0 1 11.3 0ZM136 220v20a8 8 0 0 1-16 0v-20a8 8 0 0 1 16 0Zm76.9-18.5a8.1 8.1 0 0 1 0 11.4a8.5 8.5 0 0 1-5.7 2.3a8.3 8.3 0 0 1-5.7-2.3l-14.1-14.2a8 8 0 0 1 11.3-11.3ZM248 128a8 8 0 0 1-8 8h-20a8 8 0 0 1 0-16h20a8 8 0 0 1 8 8Zm-60.6-59.4a8 8 0 0 1 0-11.3l14.1-14.2a8.1 8.1 0 0 1 11.4 11.4l-14.2 14.1a8.1 8.1 0 0 1-11.3 0Z" data-v-2a5e0da6></path></svg></a><!--]--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/guide/" data-v-b8818f8c>Guide <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/faq/" data-v-b8818f8c>F.A.Q. <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/changelog.html" data-v-b8818f8c>Changelog <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/knex/knex" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="/faq/">F.A.Q.</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/faq/recipes">Recipes</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#using-non-standard-database-that-is-compatible-with-postgresql-wire-protocol-such-as-cockroachdb">Using non-standard database that is compatible with PostgreSQL wire protocol (such as CockroachDB)</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#connecting-to-mssql-on-azure-sql-database">Connecting to MSSQL on Azure SQL Database</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#adding-a-full-text-index-for-postgresql">Adding a full-text index for PostgreSQL</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#db-access-using-sqlite-and-sqlcipher">DB access using SQLite and SQLCipher</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#maintaining-changelog-for-seeds-version-0-16-0-next1">Maintaining changelog for seeds (version &gt;= 0.16.0-next1)</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#using-explicit-transaction-management-together-with-async-code">Using explicit transaction management together with async code</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#using-parentheses-with-and-operator">Using parentheses with AND operator</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#calling-an-oracle-stored-procedure-with-bindout-variables">Calling an oracle stored procedure with bindout variables</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#node-instance-doesn-t-stop-after-using-knex">Node instance doesn&#39;t stop after using knex</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#manually-closing-streams">Manually Closing Streams</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/faq/support">Support</a><!----></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="recipes" tabindex="-1">Recipes <a class="header-anchor" href="#recipes" aria-hidden="true">#</a></h1><h2 id="using-non-standard-database-that-is-compatible-with-postgresql-wire-protocol-such-as-cockroachdb" tabindex="-1">Using non-standard database that is compatible with PostgreSQL wire protocol (such as CockroachDB) <a class="header-anchor" href="#using-non-standard-database-that-is-compatible-with-postgresql-wire-protocol-such-as-cockroachdb" aria-hidden="true">#</a></h2><p>Specify PostgreSQL version that database you are using is compatible with protocol-wise using <code>version</code> option, e. g.:</p><div class="language-js"><pre><code><span class="token keyword">const</span> knex <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;knex&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token string">&#39;pg&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">version</span><span class="token operator">:</span> <span class="token string">&#39;7.2&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">connection</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&#39;127.0.0.1&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">&#39;your_database_user&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&#39;your_database_password&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">&#39;myapp_test&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Note that value of <code>version</code> option should be not the version of the database that you are using, but version of PostgreSQL that most closely matches functionality of the database that you are using. If not provided by database vendor, try using &#39;7.2&#39; as a baseline and keep increasing (within the range of existing PostgreSQL versions) until it starts (or stops) working.</p><p>There are also known incompatibilities with migrations for databases that do not support select for update. See <a href="https://github.com/tgriesser/knex/issues/2002" target="_blank" rel="noopener noreferrer">https://github.com/tgriesser/knex/issues/2002</a> for a workaround.</p><h2 id="connecting-to-mssql-on-azure-sql-database" tabindex="-1">Connecting to MSSQL on Azure SQL Database <a class="header-anchor" href="#connecting-to-mssql-on-azure-sql-database" aria-hidden="true">#</a></h2><p><code>{encrypt: true}</code> should be included in options branch of connection configuration:</p><div class="language-js"><pre><code><span class="token function">knex</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token string">&#39;mssql&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">connection</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">&#39;mydatabase&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">server</span><span class="token operator">:</span> <span class="token string">&#39;myserver.database.windows.net&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">&#39;myuser&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&#39;mypass&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">1433</span><span class="token punctuation">,</span>
    <span class="token literal-property property">connectionTimeout</span><span class="token operator">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>
    <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">encrypt</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><a href="https://github.com/tediousjs/node-mssql#configuration-1" target="_blank" rel="noopener noreferrer">See all of node-mssql&#39;s connection options</a></p><h2 id="adding-a-full-text-index-for-postgresql" tabindex="-1">Adding a full-text index for PostgreSQL <a class="header-anchor" href="#adding-a-full-text-index-for-postgresql" aria-hidden="true">#</a></h2><div class="language-js"><pre><code>exports<span class="token punctuation">.</span><span class="token function-variable function">up</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">knex</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> knex<span class="token punctuation">.</span>schema<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">&#39;foo&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">table</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    table<span class="token punctuation">.</span><span class="token function">increments</span><span class="token punctuation">(</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    table<span class="token punctuation">.</span><span class="token function">specificType</span><span class="token punctuation">(</span><span class="token string">&#39;fulltext&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;tsvector&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    table<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">&#39;fulltext&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&#39;gin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="db-access-using-sqlite-and-sqlcipher" tabindex="-1">DB access using SQLite and SQLCipher <a class="header-anchor" href="#db-access-using-sqlite-and-sqlcipher" aria-hidden="true">#</a></h2><p>After you build the SQLCipher source and the npm SQLite3 package, and encrypt your DB (look elsewhere for these things), then anytime you open your database, you need to provide your encryption key using the SQL statement:</p><div class="language-sql"><pre><code>PRAGMA <span class="token keyword">KEY</span> <span class="token operator">=</span> <span class="token string">&#39;secret&#39;</span>
</code></pre></div><p>This PRAGMA is more completely documented in the SQLCipher site. When working with Knex this is best done when opening the DB, via the following:</p><div class="language-js"><pre><code><span class="token keyword">const</span> myDBConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token string">&#39;sqlite3&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">connection</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&#39;myEncryptedSQLiteDbFile.db&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">pool</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">afterCreate</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">conn<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      conn<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">&quot;PRAGMA KEY = &#39;secret&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> knex <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;knex&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>myDBConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Of course embedding the key value in your code is a poor security practice. Instead, retrieve the &#39;secret&#39; from elsewhere.</p><p>The key Knex thing to note here is the &quot;afterCreate&quot; function. This is documented in the <a href="http://knexjs.org" target="_blank" rel="noopener noreferrer">knexjs.org</a> site, but is not in the Table of Contents at this time, so do a browser find when on the site to get to it. It allows auto-updating DB settings when creating any new pool connections (of which there will only ever be one per file for Knex-SQLite).</p><p>If you don&#39;t use the &quot;afterCreate&quot; configuration, then you will need to run a knex.raw statement with each and every SQL you execute, something like as follows:</p><div class="language-js"><pre><code><span class="token keyword">return</span> knex<span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">&quot;PRAGMA KEY = &#39;secret&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">knex</span><span class="token punctuation">(</span><span class="token string">&#39;some_table&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;query-error&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ex<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;KNEX select from some_table ERR ex:&#39;</span><span class="token punctuation">,</span> ex<span class="token punctuation">,</span> <span class="token string">&#39;obj:&#39;</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="maintaining-changelog-for-seeds-version-0-16-0-next1" tabindex="-1">Maintaining changelog for seeds (version &gt;= 0.16.0-next1) <a class="header-anchor" href="#maintaining-changelog-for-seeds-version-0-16-0-next1" aria-hidden="true">#</a></h2><p>In case you would like to use Knex.js changelog functionality to ensure your environments are only seeded once, but don&#39;t want to mix seed files with migration files, you can specify multiple directories as a source for your migrations:</p><div class="language-ts"><pre><code><span class="token keyword">await</span> knex<span class="token punctuation">.</span>migrate<span class="token punctuation">.</span><span class="token function">latest</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  directory<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&#39;src/services/orders/database/migrations&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;src/services/orders/database/seeds&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  sortDirsSeparately<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  tableName<span class="token operator">:</span> <span class="token string">&#39;orders_migrations&#39;</span><span class="token punctuation">,</span>
  schemaName<span class="token operator">:</span> <span class="token string">&#39;orders&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="using-explicit-transaction-management-together-with-async-code" tabindex="-1">Using explicit transaction management together with async code <a class="header-anchor" href="#using-explicit-transaction-management-together-with-async-code" aria-hidden="true">#</a></h2><div class="language-ts"><pre><code><span class="token keyword">await</span> knex<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">(</span>trx<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">stuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    trx<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;Foo&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">stuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Or alternatively:</p><div class="language-ts"><pre><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> knex<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">(</span>trx<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">stuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      trx<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;always explicit rollback this time&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">stuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// transaction was committed</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// transaction was rolled back</span>
<span class="token punctuation">}</span>
</code></pre></div><p>(note that promise for <code>knex.transaction</code> resolves after transaction is rolled back or committed)</p><h2 id="using-parentheses-with-and-operator" tabindex="-1">Using parentheses with AND operator <a class="header-anchor" href="#using-parentheses-with-and-operator" aria-hidden="true">#</a></h2><p>In order to generate query along the lines of</p><div class="language-sql"><pre><code><span class="token keyword">SELECT</span> <span class="token string">&quot;firstName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;lastName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;status&quot;</span>
<span class="token keyword">FROM</span> <span class="token string">&quot;userInfo&quot;</span>
<span class="token keyword">WHERE</span> <span class="token string">&quot;status&quot;</span> <span class="token operator">=</span> <span class="token string">&#39;active&#39;</span>
<span class="token operator">AND</span> <span class="token punctuation">(</span><span class="token string">&quot;firstName&quot;</span> <span class="token operator">ILIKE</span> <span class="token string">&#39;%Ali%&#39;</span> <span class="token operator">OR</span> <span class="token string">&quot;lastName&quot;</span> <span class="token operator">ILIKE</span> <span class="token string">&#39;%Ali%&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>you need to use following approach:</p><div class="language-js"><pre><code>queryBuilder
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&#39;status&#39;</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span>uuid<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">qB</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    qB
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">&#39;firstName&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;ilike&#39;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">%</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>q<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token string">&#39;lastName&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;ilike&#39;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">%</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>q<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="calling-an-oracle-stored-procedure-with-bindout-variables" tabindex="-1">Calling an oracle stored procedure with bindout variables <a class="header-anchor" href="#calling-an-oracle-stored-procedure-with-bindout-variables" aria-hidden="true">#</a></h2><p>How to call and retrieve output from an oracle stored procedure</p><div class="language-ts"><pre><code><span class="token keyword">const</span> oracle <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&#39;oracledb&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bindVars <span class="token operator">=</span> <span class="token punctuation">{</span>
  input_var1<span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
  input_var2<span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
  output_var<span class="token operator">:</span> <span class="token punctuation">{</span>
    dir<span class="token operator">:</span> oracle<span class="token punctuation">.</span><span class="token constant">BIND_OUT</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  output_message<span class="token operator">:</span> <span class="token punctuation">{</span>
    dir<span class="token operator">:</span> oracle<span class="token punctuation">.</span><span class="token constant">BIND_OUT</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sp <span class="token operator">=</span>
  <span class="token string">&#39;BEGIN MULTIPLY_STORED_PROCEDURE(:input_var1, :input_var2, :output_var, :output_message); END;&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword">await</span> knex<span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> bindVars<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6 * 7 is the answer to life</span>
</code></pre></div><h2 id="node-instance-doesn-t-stop-after-using-knex" tabindex="-1">Node instance doesn&#39;t stop after using knex <a class="header-anchor" href="#node-instance-doesn-t-stop-after-using-knex" aria-hidden="true">#</a></h2><p>Make sure to close knex instance after execution to avoid Node process hanging due to open connections:</p><div class="language-js"><pre><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">migrate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> knex<span class="token punctuation">.</span>migrate<span class="token punctuation">.</span><span class="token function">latest</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">/**config**/</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      knex<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ignore</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">migrate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="manually-closing-streams" tabindex="-1">Manually Closing Streams <a class="header-anchor" href="#manually-closing-streams" aria-hidden="true">#</a></h2><p>When using Knex&#39;s <a href="/guide/interfaces.html#streams">stream interface</a>, you can typically just <code>pipe</code> the return stream to any writable stream. However, with <a href="http://nodejs.org/api/http.html#http_http_incomingmessage" target="_blank" rel="noopener noreferrer"><code>HTTPIncomingMessage</code></a>, you&#39;ll need to take special care to handle aborted requests.</p><p>An <code>HTTPIncomingMessage</code> object is typically called <code>request</code>. This is the first argument in <code>&#39;request&#39;</code> events emitted on <code>http.Server</code> instances. <a href="http://expressjs.com/4x/api.html#request" target="_blank" rel="noopener noreferrer">Express&#39;s <code>req</code></a> implements a compatible interface and Hapi exposes this object on <a href="http://hapijs.com/api#request-object" target="_blank" rel="noopener noreferrer">its request objects</a> as <code>request.raw.req</code>.</p><p>You need to explicitly handle the case where an <code>HTTPIncomingMessage</code> is closed prematurely when streaming from a database with Knex. The easiest way to cause this is:</p><ol><li>Visit an endpoint that takes several seconds to fully transmit a response</li><li>Close the browser window immediately after beginning the request</li></ol><p>When this happens while you are streaming a query to a client, you need to manually tell Knex that it can release the database connection in use back to the connection pool.</p><div class="language-js"><pre><code>server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;request&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> knex<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&#39;*&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&#39;items&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  request<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;close&#39;</span><span class="token punctuation">,</span> stream<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-07c132fc><div class="edit" data-v-07c132fc><div class="edit-link" data-v-07c132fc data-v-1ed99556><a class="link" href="https://github.com/knex/knex/edit/master/docs/src/faq/recipes.md" target="_blank" rel="noopener noreferrer" data-v-1ed99556>Edit this page on GitHub <svg class="icon outbound icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-1ed99556><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="updated" data-v-07c132fc><!----></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><a class="link" href="/faq/" data-v-38ede35f><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-38ede35f><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-38ede35f>F.A.Q.</span></a></div><div class="next" data-v-38ede35f><a class="link" href="/faq/support" data-v-38ede35f><span class="text" data-v-38ede35f>Support</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"changelog.md\":\"17672f85\",\"faq_index.md\":\"5b931eb6\",\"faq_recipes.md\":\"9519710b\",\"faq_support.md\":\"3a1bb589\",\"guide_extending.md\":\"fba00f2b\",\"guide_index.md\":\"8af088ee\",\"guide_interfaces.md\":\"69039f37\",\"guide_migrations.md\":\"a3b60bcd\",\"guide_query-builder.md\":\"bcead624\",\"guide_raw.md\":\"82150b7b\",\"guide_ref.md\":\"871a08f0\",\"guide_schema-builder.md\":\"8594d7f3\",\"guide_transactions.md\":\"287f817f\",\"guide_utility.md\":\"36a2823b\",\"index.md\":\"09ca53f9\"}")</script>
    <script type="module" async src="/assets/app.36cb52e5.js"></script>
    
  </body>
</html>