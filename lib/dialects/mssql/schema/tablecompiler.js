/* eslint max-len:0 */

// MSSQL Table Builder & Compiler
// -------
'use strict';

exports.__esModule = true;

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj['default'] = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _inherits = require('inherits');

var _inherits2 = _interopRequireDefault(_inherits);

var _schemaTablecompiler = require('../../../schema/tablecompiler');

var _schemaTablecompiler2 = _interopRequireDefault(_schemaTablecompiler);

var _helpers = require('../../../helpers');

var helpers = _interopRequireWildcard(_helpers);

var _promise = require('../../../promise');

var _promise2 = _interopRequireDefault(_promise);

var _lodash = require('lodash');

// Table Compiler
// ------

function TableCompiler_MSSQL() {
  _schemaTablecompiler2['default'].apply(this, arguments);
}
_inherits2['default'](TableCompiler_MSSQL, _schemaTablecompiler2['default']);

_lodash.assign(TableCompiler_MSSQL.prototype, {

  createAlterTableMethods: ['foreign', 'primary', 'unique'],
  createQuery: function createQuery(columns, ifNot) {
    var createStatement = ifNot ? 'if object_id(\'' + this.tableName() + '\', \'U\') is null CREATE TABLE ' : 'CREATE TABLE ';
    var sql = createStatement + this.tableName() + (this._formatting ? ' (\n    ' : ' (') + columns.sql.join(this._formatting ? ',\n    ' : ', ') + ')';

    if (this.single.comment) {
      var comment = this.single.comment || '';
      if (comment.length > 60) helpers.warn('The max length for a table comment is 60 characters');
    }

    this.pushQuery(sql);
  },

  lowerCase: false,

  addColumnsPrefix: 'ADD ',

  dropColumnPrefix: 'DROP COLUMN ',

  // Compiles column add.  Multiple columns need only one ADD clause (not one ADD per column) so core addColumns doesn't work.  #1348
  addColumns: function addColumns(columns) {
    if (columns.sql.length > 0) {
      this.pushQuery({
        sql: (this.lowerCase ? 'alter table ' : 'ALTER TABLE ') + this.tableName() + ' ' + this.addColumnsPrefix + columns.sql.join(', '),
        bindings: columns.bindings
      });
    }
  },

  // Compiles column drop.  Multiple columns need only one DROP clause (not one DROP per column) so core dropColumn doesn't work.  #1348
  dropColumn: function dropColumn() {
    var _this2 = this;
    var columns = helpers.normalizeArr.apply(null, arguments);

    var drops = (Array.isArray(columns) ? columns : [columns]).map(function (column) {
      return _this2.formatter.wrap(column);
    });
    this.pushQuery((this.lowerCase ? 'alter table ' : 'ALTER TABLE ') + this.tableName() + ' ' + this.dropColumnPrefix + drops.join(', '));
  },

  // Compiles the comment on the table.
  comment: function comment() {},

  changeType: function changeType() {},

  // Renames a column on the table.
  renameColumn: function renameColumn(from, to) {
    this.pushQuery('exec sp_rename ' + this.formatter.parameter(this.tableName() + '.' + from) + ', ' + this.formatter.parameter(to) + ', \'COLUMN\'');
  },

  dropFKRefs: function dropFKRefs(runner, refs) {
    var formatter = this.client.formatter();
    return _promise2['default'].all(refs.map(function (ref) {
      var constraintName = formatter.wrap(ref.CONSTRAINT_NAME);
      var tableName = formatter.wrap(ref.TABLE_NAME);
      return runner.query({
        sql: 'ALTER TABLE ' + tableName + ' DROP CONSTRAINT ' + constraintName
      });
    }));
  },
  createFKRefs: function createFKRefs(runner, refs) {
    var formatter = this.client.formatter();

    return _promise2['default'].all(refs.map(function (ref) {
      var tableName = formatter.wrap(ref.TABLE_NAME);
      var keyName = formatter.wrap(ref.CONSTRAINT_NAME);
      var column = formatter.columnize(ref.COLUMN_NAME);
      var references = formatter.columnize(ref.REFERENCED_COLUMN_NAME);
      var inTable = formatter.wrap(ref.REFERENCED_TABLE_NAME);
      var onUpdate = ' ON UPDATE ' + ref.UPDATE_RULE;
      var onDelete = ' ON DELETE ' + ref.DELETE_RULE;

      return runner.query({
        sql: 'ALTER TABLE ' + tableName + ' ADD CONSTRAINT ' + keyName + ' FOREIGN KEY (' + column + ') REFERENCES ' + inTable + ' (' + references + ')' + onUpdate + onDelete
      });
    }));
  },

  index: function index(columns, indexName) {
    indexName = indexName ? this.formatter.wrap(indexName) : this._indexCommand('index', this.tableNameRaw, columns);
    this.pushQuery('CREATE INDEX ' + indexName + ' ON ' + this.tableName() + ' (' + this.formatter.columnize(columns) + ')');
  },

  primary: function primary(columns, constraintName) {
    constraintName = constraintName ? this.formatter.wrap(constraintName) : this._indexCommand('primary', this.tableNameRaw, columns);
    if (!this.forCreate) {
      this.pushQuery('ALTER TABLE ' + this.tableName() + ' ADD CONSTRAINT ' + constraintName + ' PRIMARY KEY (' + this.formatter.columnize(columns) + ')');
    } else {
      this.pushQuery('CONSTRAINT ' + constraintName + ' PRIMARY KEY (' + this.formatter.columnize(columns) + ')');
    }
  },

  unique: function unique(columns, indexName) {
    indexName = indexName ? this.formatter.wrap(indexName) : this._indexCommand('unique', this.tableNameRaw, columns);
    if (!this.forCreate) {
      this.pushQuery('CREATE UNIQUE INDEX ' + indexName + ' ON ' + this.tableName() + ' (' + this.formatter.columnize(columns) + ')');
    } else {
      this.pushQuery('CONSTRAINT ' + indexName + ' UNIQUE (' + this.formatter.columnize(columns) + ')');
    }
  },

  // Compile a drop index command.
  dropIndex: function dropIndex(columns, indexName) {
    indexName = indexName ? this.formatter.wrap(indexName) : this._indexCommand('index', this.tableNameRaw, columns);
    this.pushQuery('DROP INDEX ' + indexName + ' ON ' + this.tableName());
  },

  // Compile a drop foreign key command.
  dropForeign: function dropForeign(columns, indexName) {
    indexName = indexName ? this.formatter.wrap(indexName) : this._indexCommand('foreign', this.tableNameRaw, columns);
    this.pushQuery('ALTER TABLE ' + this.tableName() + ' DROP CONSTRAINT ' + indexName);
  },

  // Compile a drop primary key command.
  dropPrimary: function dropPrimary() {
    this.pushQuery('ALTER TABLE ' + this.tableName() + ' DROP PRIMARY KEY');
  },

  // Compile a drop unique key command.
  dropUnique: function dropUnique(column, indexName) {
    indexName = indexName ? this.formatter.wrap(indexName) : this._indexCommand('unique', this.tableNameRaw, column);
    this.pushQuery('ALTER TABLE ' + this.tableName() + ' DROP CONSTRAINT ' + indexName);
  }

});

exports['default'] = TableCompiler_MSSQL;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kaWFsZWN0cy9tc3NxbC9zY2hlbWEvdGFibGVjb21waWxlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7d0JBSXFCLFVBQVU7Ozs7bUNBQ0wsK0JBQStCOzs7O3VCQUNoQyxrQkFBa0I7O0lBQS9CLE9BQU87O3VCQUNDLGtCQUFrQjs7OztzQkFFZixRQUFROzs7OztBQUsvQixTQUFTLG1CQUFtQixHQUFHO0FBQzdCLG1DQUFjLEtBQUssQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7Q0FDdEM7QUFDRCxzQkFBUyxtQkFBbUIsbUNBQWdCLENBQUM7O0FBRTdDLGVBQU8sbUJBQW1CLENBQUMsU0FBUyxFQUFFOztBQUVwQyx5QkFBdUIsRUFBRSxDQUFDLFNBQVMsRUFBRSxTQUFTLEVBQUUsUUFBUSxDQUFDO0FBQ3pELGFBQVcsRUFBQyxxQkFBQyxPQUFPLEVBQUUsS0FBSyxFQUFFO0FBQzNCLFFBQU0sZUFBZSxHQUFHLEtBQUssdUJBQW9CLElBQUksQ0FBQyxTQUFTLEVBQUUsd0NBQWtDLGVBQWUsQ0FBQztBQUNuSCxRQUFNLEdBQUcsR0FBRyxlQUFlLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLElBQUksQ0FBQyxXQUFXLEdBQUcsVUFBVSxHQUFHLElBQUksQ0FBQSxBQUFDLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsR0FBRyxDQUFDOztBQUV0SixRQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFO0FBQ3ZCLFVBQU0sT0FBTyxHQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxJQUFJLEVBQUUsQUFBQyxDQUFDO0FBQzVDLFVBQUksT0FBTyxDQUFDLE1BQU0sR0FBRyxFQUFFLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxxREFBcUQsQ0FBQyxDQUFDO0tBQzlGOztBQUVE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YXgtbGVuOjAgKi9cblxuLy8gTVNTUUwgVGFibGUgQnVpbGRlciAmIENvbXBpbGVyXG4vLyAtLS0tLS0tXG5pbXBvcnQgaW5oZXJpdHMgZnJvbSAnaW5oZXJpdHMnO1xuaW1wb3J0IFRhYmxlQ29tcGlsZXIgZnJvbSAnLi4vLi4vLi4vc2NoZW1hL3RhYmxlY29tcGlsZXInO1xuaW1wb3J0ICogYXMgaGVscGVycyBmcm9tICcuLi8uLi8uLi9oZWxwZXJzJztcbmltcG9ydCBQcm9taXNlIGZyb20gJy4uLy4uLy4uL3Byb21pc2UnO1xuXG5pbXBvcnQgeyBhc3NpZ24gfSBmcm9tICdsb2Rhc2gnXG5cbi8vIFRhYmxlIENvbXBpbGVyXG4vLyAtLS0tLS1cblxuZnVuY3Rpb24gVGFibGVDb21waWxlcl9NU1NRTCgpIHtcbiAgVGFibGVDb21waWxlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xufVxuaW5oZXJpdHMoVGFibGVDb21waWxlcl9NU1NRTCwgVGFibGVDb21waWxlcik7XG5cbmFzc2lnbihUYWJsZUNvbXBpbGVyX01TU1FMLnByb3RvdHlwZSwge1xuXG4gIGNyZWF0ZUFsdGVyVGFibGVNZXRob2RzOiBbJ2ZvcmVpZ24nLCAncHJpbWFyeScsICd1bmlxdWUnXSxcbiAgY3JlYXRlUXVlcnkgKGNvbHVtbnMsIGlmTm90KSB7XG4gICAgY29uc3QgY3JlYXRlU3RhdGVtZW50ID0gaWZOb3QgPyBgaWYgb2JqZWN0X2lkKCcke3RoaXMudGFibGVOYW1lKCl9JywgJ1UnKSBpcyBudWxsIENSRUFURSBUQUJMRSBgIDogJ0NSRUFURSBUQUJMRSAnO1xuICAgIGNvbnN0IHNxbCA9IGNyZWF0ZVN0YXRlbWVudCArIHRoaXMudGFibGVOYW1lKCkgKyAodGhpcy5fZm9ybWF0dGluZyA/ICcgKFxcbiAgICAnIDogJyAoJykgKyBjb2x1bW5zLnNxbC5qb2luKHRoaXMuX2Zvcm1hdHRpbmcgPyAnLFxcbiAgICAnIDogJywgJykgKyAnKSc7XG5cbiAgICBpZiAodGhpcy5zaW5nbGUuY29tbWVudCkge1xuICAgICAgY29uc3QgY29tbWVudCA9ICh0aGlzLnNpbmdsZS5jb21tZW50IHx8ICcnKTtcbiAgICAgIGlmIChjb21tZW50Lmxlbmd0aCA+IDYwKSBoZWxwZXJzLndhcm4oJ1RoZSBtYXggbGVuZ3RoIGZvciBhIHRhYmxlIGNvbW1lbnQgaXMgNjAgY2hhcmFjdGVycycpO1xuICAgIH1cblxuICAgIHRoaXMucHVzaFF1ZXJ5KHNxbCk7XG4gIH0sXG5cbiAgbG93ZXJDYXNlOiBmYWxzZSxcblxuICBhZGRDb2x1bW5zUHJlZml4OiAnQUREICcsXG5cbiAgZHJvcENvbHVtblByZWZpeDogJ0RST1AgQ09MVU1OICcsXG5cbiAgLy8gQ29tcGlsZXMgY29sdW1uIGFkZC4gIE11bHRpcGxlIGNvbHVtbnMgbmVlZCBvbmx5IG9uZSBBREQgY2xhdXNlIChub3Qgb25lIEFERCBwZXIgY29sdW1uKSBzbyBjb3JlIGFkZENvbHVtbnMgZG9lc24ndCB3b3JrLiAgIzEzNDhcbiAgYWRkQ29sdW1ucyAoY29sdW1ucykge1xuICAgIGlmIChjb2x1bW5zLnNxbC5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLnB1c2hRdWVyeSh7XG4gICAgICAgIHNxbDogKHRoaXMubG93ZXJDYXNlID8gJ2FsdGVyIHRhYmxlICcgOiAnQUxURVIgVEFCTEUgJykgKyB0aGlzLnRhYmxlTmFtZSgpICsgJyAnICsgdGhpcy5hZGRDb2x1bW5zUHJlZml4ICsgY29sdW1ucy5zcWwuam9pbignLCAnKSxcbiAgICAgICAgYmluZGluZ3M6IGNvbHVtbnMuYmluZGluZ3NcbiAgICAgIH0pO1xuICAgIH1cbiAgfSxcblxuICAvLyBDb21waWxlcyBjb2x1bW4gZHJvcC4gIE11bHRpcGxlIGNvbHVtbnMgbmVlZCBvbmx5IG9uZSBEUk9QIGNsYXVzZSAobm90IG9uZSBEUk9QIHBlciBjb2x1bW4pIHNvIGNvcmUgZHJvcENvbHVtbiBkb2Vzbid0IHdvcmsuICAjMTM0OFxuICBkcm9wQ29sdW1uICgpIHtcbiAgICBjb25zdCBfdGhpczIgPSB0aGlzO1xuICAgIGNvbnN0IGNvbHVtbnMgPSBoZWxwZXJzLm5vcm1hbGl6ZUFyci5hcHBseShudWxsLCBhcmd1bWVudHMpO1xuXG4gICAgY29uc3QgZHJvcHMgPSAoQXJyYXkuaXNBcnJheShjb2x1bW5zKSA/IGNvbHVtbnMgOiBbY29sdW1uc10pLm1hcChjb2x1bW4gPT4gX3RoaXMyLmZvcm1hdHRlci53cmFwKGNvbHVtbikpO1xuICAgIHRoaXMucHVzaFF1ZXJ5KCh0aGlzLmxvd2VyQ2FzZSA/ICdhbHRlciB0YWJsZSAnIDogJ0FMVEVSIFRBQkxFICcpICsgdGhpcy50YWJsZU5hbWUoKSArICcgJyArIHRoaXMuZHJvcENvbHVtblByZWZpeCArIGRyb3BzLmpvaW4oJywgJykpO1xuICB9LFxuXG4gIC8vIENvbXBpbGVzIHRoZSBjb21tZW50IG9uIHRoZSB0YWJsZS5cbiAgY29tbWVudCAoKSB7XG4gIH0sXG5cbiAgY2hhbmdlVHlwZSAoKSB7XG4gIH0sXG5cbiAgLy8gUmVuYW1lcyBhIGNvbHVtbiBvbiB0aGUgdGFibGUuXG4gIHJlbmFtZUNvbHVtbiAoZnJvbSwgdG8pIHtcbiAgICB0aGlzLnB1c2hRdWVyeShgZXhlYyBzcF9yZW5hbWUgJHt0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXIodGhpcy50YWJsZU5hbWUoKSArICcuJyArIGZyb20pfSwgJHt0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXIodG8pfSwgJ0NPTFVNTidgKTtcbiAgfSxcblxuICBkcm9wRktSZWZzIChydW5uZXIsIHJlZnMpIHtcbiAgICBjb25zdCBmb3JtYXR0ZXIgPSB0aGlzLmNsaWVudC5mb3JtYXR0ZXIoKTtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwocmVmcy5tYXAoZnVuY3Rpb24gKHJlZikge1xuICAgICAgY29uc3QgY29uc3RyYWludE5hbWUgPSBmb3JtYXR0ZXIud3JhcChyZWYuQ09OU1RSQUlOVF9OQU1FKTtcbiAgICAgIGNvbnN0IHRhYmxlTmFtZSA9IGZvcm1hdHRlci53cmFwKHJlZi5UQUJMRV9OQU1FKTtcbiAgICAgIHJldHVybiBydW5uZXIucXVlcnkoe1xuICAgICAgICBzcWw6IGBBTFRFUiBUQUJMRSAke3RhYmxlTmFtZX0gRFJPUCBDT05TVFJBSU5UICR7Y29uc3RyYWludE5hbWV9YFxuICAgICAgfSk7XG4gICAgfSkpO1xuICB9LFxuICBjcmVhdGVGS1JlZnMgKHJ1bm5lciwgcmVmcykge1xuICAgIGNvbnN0IGZvcm1hdHRlciA9IHRoaXMuY2xpZW50LmZvcm1hdHRlcigpO1xuXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKHJlZnMubWFwKGZ1bmN0aW9uIChyZWYpIHtcbiAgICAgIGNvbnN0IHRhYmxlTmFtZSA9IGZvcm1hdHRlci53cmFwKHJlZi5UQUJMRV9OQU1FKTtcbiAgICAgIGNvbnN0IGtleU5hbWUgPSBmb3JtYXR0ZXIud3JhcChyZWYuQ09OU1RSQUlOVF9OQU1FKTtcbiAgICAgIGNvbnN0IGNvbHVtbiA9IGZvcm1hdHRlci5jb2x1bW5pemUocmVmLkNPTFVNTl9OQU1FKTtcbiAgICAgIGNvbnN0IHJlZmVyZW5jZXMgPSBmb3JtYXR0ZXIuY29sdW1uaXplKHJlZi5SRUZFUkVOQ0VEX0NPTFVNTl9OQU1FKTtcbiAgICAgIGNvbnN0IGluVGFibGUgPSBmb3JtYXR0ZXIud3JhcChyZWYuUkVGRVJFTkNFRF9UQUJMRV9OQU1FKTtcbiAgICAgIGNvbnN0IG9uVXBkYXRlID0gYCBPTiBVUERBVEUgJHtyZWYuVVBEQVRFX1JVTEV9YDtcbiAgICAgIGNvbnN0IG9uRGVsZXRlID0gYCBPTiBERUxFVEUgJHtyZWYuREVMRVRFX1JVTEV9YDtcblxuICAgICAgcmV0dXJuIHJ1bm5lci5xdWVyeSh7XG4gICAgICAgIHNxbDogYEFMVEVSIFRBQkxFICR7dGFibGVOYW1lfSBBREQgQ09OU1RSQUlOVCAke2tleU5hbWV9YCArXG4gICAgICAgICcgRk9SRUlHTiBLRVkgKCcgKyBjb2x1bW4gKyAnKSBSRUZFUkVOQ0VTICcgKyBpblRhYmxlICsgJyAoJyArIHJlZmVyZW5jZXMgKyAnKScgKyBvblVwZGF0ZSArIG9uRGVsZXRlXG4gICAgICB9KTtcbiAgICB9KSk7XG4gIH0sXG5cbiAgaW5kZXggKGNvbHVtbnMsIGluZGV4TmFtZSkge1xuICAgIGluZGV4TmFtZSA9IGluZGV4TmFtZSA/IHRoaXMuZm9ybWF0dGVyLndyYXAoaW5kZXhOYW1lKSA6IHRoaXMuX2luZGV4Q29tbWFuZCgnaW5kZXgnLCB0aGlzLnRhYmxlTmFtZVJhdywgY29sdW1ucyk7XG4gICAgdGhpcy5wdXNoUXVlcnkoYENSRUFURSBJTkRFWCAke2luZGV4TmFtZX0gT04gJHt0aGlzLnRhYmxlTmFtZSgpfSAoJHt0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoY29sdW1ucyl9KWApO1xuICB9LFxuXG4gIHByaW1hcnkgKGNvbHVtbnMsIGNvbnN0cmFpbnROYW1lKSB7XG4gICAgY29uc3RyYWludE5hbWUgPSBjb25zdHJhaW50TmFtZSA/IHRoaXMuZm9ybWF0dGVyLndyYXAoY29uc3RyYWludE5hbWUpIDogdGhpcy5faW5kZXhDb21tYW5kKCdwcmltYXJ5JywgdGhpcy50YWJsZU5hbWVSYXcsIGNvbHVtbnMpO1xuICAgIGlmICghdGhpcy5mb3JDcmVhdGUpIHtcbiAgICAgIHRoaXMucHVzaFF1ZXJ5KGBBTFRFUiBUQUJMRSAke3RoaXMudGFibGVOYW1lKCl9IEFERCBDT05TVFJBSU5UICR7Y29uc3RyYWludE5hbWV9IFBSSU1BUlkgS0VZICgke3RoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShjb2x1bW5zKX0pYCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucHVzaFF1ZXJ5KGBDT05TVFJBSU5UICR7Y29uc3RyYWludE5hbWV9IFBSSU1BUlkgS0VZICgke3RoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShjb2x1bW5zKX0pYCk7XG4gICAgfVxuICB9LFxuXG4gIHVuaXF1ZSAoY29sdW1ucywgaW5kZXhOYW1lKSB7XG4gICAgaW5kZXhOYW1lID0gaW5kZXhOYW1lID8gdGhpcy5mb3JtYXR0ZXIud3JhcChpbmRleE5hbWUpIDogdGhpcy5faW5kZXhDb21tYW5kKCd1bmlxdWUnLCB0aGlzLnRhYmxlTmFtZVJhdywgY29sdW1ucyk7XG4gICAgaWYgKCF0aGlzLmZvckNyZWF0ZSkge1xuICAgICAgdGhpcy5wdXNoUXVlcnkoYENSRUFURSBVTklRVUUgSU5ERVggJHtpbmRleE5hbWV9IE9OICR7dGhpcy50YWJsZU5hbWUoKX0gKCR7dGhpcy5mb3JtYXR0ZXIuY29sdW1uaXplKGNvbHVtbnMpfSlgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5wdXNoUXVlcnkoYENPTlNUUkFJTlQgJHtpbmRleE5hbWV9IFVOSVFVRSAoJHt0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoY29sdW1ucyl9KWApO1xuICAgIH1cbiAgfSxcblxuICAvLyBDb21waWxlIGEgZHJvcCBpbmRleCBjb21tYW5kLlxuICBkcm9wSW5kZXggKGNvbHVtbnMsIGluZGV4TmFtZSkge1xuICAgIGluZGV4TmFtZSA9IGluZGV4TmFtZSA/IHRoaXMuZm9ybWF0dGVyLndyYXAoaW5kZXhOYW1lKSA6IHRoaXMuX2luZGV4Q29tbWFuZCgnaW5kZXgnLCB0aGlzLnRhYmxlTmFtZVJhdywgY29sdW1ucyk7XG4gICAgdGhpcy5wdXNoUXVlcnkoYERST1AgSU5ERVggJHtpbmRleE5hbWV9IE9OICR7dGhpcy50YWJsZU5hbWUoKX1gKTtcbiAgfSxcblxuICAvLyBDb21waWxlIGEgZHJvcCBmb3JlaWduIGtleSBjb21tYW5kLlxuICBkcm9wRm9yZWlnbiAoY29sdW1ucywgaW5kZXhOYW1lKSB7XG4gICAgaW5kZXhOYW1lID0gaW5kZXhOYW1lID8gdGhpcy5mb3JtYXR0ZXIud3JhcChpbmRleE5hbWUpIDogdGhpcy5faW5kZXhDb21tYW5kKCdmb3JlaWduJywgdGhpcy50YWJsZU5hbWVSYXcsIGNvbHVtbnMpO1xuICAgIHRoaXMucHVzaFF1ZXJ5KGBBTFRFUiBUQUJMRSAke3RoaXMudGFibGVOYW1lKCl9IERST1AgQ09OU1RSQUlOVCAke2luZGV4TmFtZX1gKTtcbiAgfSxcblxuICAvLyBDb21waWxlIGEgZHJvcCBwcmltYXJ5IGtleSBjb21tYW5kLlxuICBkcm9wUHJpbWFyeSAoKSB7XG4gICAgdGhpcy5wdXNoUXVlcnkoYEFMVEVSIFRBQkxFICR7dGhpcy50YWJsZU5hbWUoKX0gRFJPUCBQUklNQVJZIEtFWWApO1xuICB9LFxuXG4gIC8vIENvbXBpbGUgYSBkcm9wIHVuaXF1ZSBrZXkgY29tbWFuZC5cbiAgZHJvcFVuaXF1ZSAoY29sdW1uLCBpbmRleE5hbWUpIHtcbiAgICBpbmRleE5hbWUgPSBpbmRleE5hbWUgPyB0aGlzLmZvcm1hdHRlci53cmFwKGluZGV4TmFtZSkgOiB0aGlzLl9pbmRleENvbW1hbmQoJ3VuaXF1ZScsIHRoaXMudGFibGVOYW1lUmF3LCBjb2x1bW4pO1xuICAgIHRoaXMucHVzaFF1ZXJ5KGBBTFRFUiBUQUJMRSAke3RoaXMudGFibGVOYW1lKCl9IERST1AgQ09OU1RSQUlOVCAke2luZGV4TmFtZX1gKTtcbiAgfVxuXG59KVxuXG5leHBvcnQgZGVmYXVsdCBUYWJsZUNvbXBpbGVyX01TU1FMO1xuIl19