
// Oracledb Client
// -------
'use strict';

var _ = require('lodash');
var inherits = require('inherits');
var Client_Oracle = require('../oracle');
var QueryCompiler = require('./query/compiler');
var ColumnCompiler = require('./schema/columncompiler');
var Formatter = require('./formatter');
var BlobHelper = require('./utils').BlobHelper;
var ReturningHelper = require('./utils').ReturningHelper;
var Promise = require('../../promise');
var stream = require('stream');
var helpers = require('../../helpers');
var Transaction = require('./transaction');

function Client_Oracledb() {
  Client_Oracle.apply(this, arguments);
  // Node.js only have 4 background threads by default, oracledb needs one by connection
  if (this.driver) {
    process.env.UV_THREADPOOL_SIZE = process.env.UV_THREADPOOL_SIZE || 1;
    process.env.UV_THREADPOOL_SIZE += this.driver.poolMax;
  }
}
inherits(Client_Oracledb, Client_Oracle);

Client_Oracledb.prototype.driverName = 'oracledb';

Client_Oracledb.prototype._driver = function () {
  var oracledb = require('oracledb');
  return oracledb;
};

Client_Oracledb.prototype.QueryCompiler = QueryCompiler;
Client_Oracledb.prototype.ColumnCompiler = ColumnCompiler;
Client_Oracledb.prototype.Formatter = Formatter;
Client_Oracledb.prototype.Transaction = Transaction;

Client_Oracledb.prototype.prepBindings = function (bindings) {
  var self = this;
  return _.map(bindings, function (value) {
    if (value instanceof BlobHelper && self.driver) {
      return { type: self.driver.BLOB, dir: self.driver.BIND_OUT };
      // Returning helper always use ROWID as string
    } else if (value instanceof ReturningHelper && self.driver) {
        return { type: self.driver.STRING, dir: self.driver.BIND_OUT };
      } else if (typeof value === 'boolean') {
        return value ? 1 : 0;
      }
    return value;
  });
};

// Get a raw connection, called by the `pool` whenever a new
// connection needs to be added to the pool.
Client_Oracledb.prototype.acquireRawConnection = function () {
  var client = this;
  var asyncConnection = new Promise(function (resolver, rejecter) {
    client.driver.getConnection({
      user: client.connectionSettings.user,
      password: client.connectionSettings.password,
      connectString: client.connectionSettings.host + '/' + client.connectionSettings.database
    }, function (err, connection) {
      if (err) return rejecter(err);
      if (client.connectionSettings.prefetchRowCount) {
        connection.setPrefetchRowCount(client.connectionSettings.prefetchRowCount);
      }

      connection.commitAsync = function () {
        var self = this;
        return new Promise(function (commitResolve, commitReject) {
          if (connection.isTransaction) {
            return commitResolve();
          }
          self.commit(function (err) {
            if (err) {
              return commitReject(err);
            }
            commitResolve();
          });
        });
      };
      connection.rollbackAsync = function () {
        var self = this;
        return new Promise(function (rollbackResolve, rollbackReject) {
          self.rollback(function (err) {
            if (err) {
              return rollbackReject(err);
            }
            rollbackResolve();
          });
        });
      };
      var fetchAsync = function fetchAsync(sql, bindParams, options, cb) {
        options = options || {};
        options.outFormat = client.driver.OBJECT;
        if (options.resultSet) {
          connection.execute(sql, bindParams || [], options, function (err, result) {
            if (err) {
              return cb(err);
            }
            var fetchResult = { rows: [], resultSet: result.resultSet };
            var numRows = 100;
            var fetchRowsFromRS = function fetchRowsFromRS(connection, resultSet, numRows) {
              resultSet.getRows(numRows, function (err, rows) {
                if (err) {
                  resultSet.close(function () {
                    return cb(err);
                  });
                } else if (rows.length === 0) {
                  return cb(null, fetchResult);
                } else if (rows.length > 0) {
                  if (rows.length === numRows) {
                    fetchResult.rows = fetchResult.rows.concat(rows);
                    fetchRowsFromRS(connection, resultSet, numRows);
                  } else {
                    fetchResult.rows = fetchResult.rows.concat(rows);
                    return cb(null, fetchResult);
                  }
                }
              });
            };
            fetchRowsFromRS(connection, result.resultSet, numRows);
          });
        } else {
          connection.execute(sql, bindParams || [], options, cb);
        }
      };
      connection.executeAsync = function (sql, bindParams, options) {
        // Read all lob
        return new Promise(function (resultResolve, resultReject) {
          fetchAsync(sql, bindParams, options, function (err, results) {
            if (err) {
              return resultReject(err);
            }
            // Collect LOBs to read
            var lobs = [];
            if (results.rows) {
              if (Array.isArray(results.rows)) {
                for (var i = 0; i < results.rows.length; i++) {
                  // Iterate through the rows
                  var row = results.rows[i];
                  for (var column in row) {
                    if (row[column] instanceof stream.Readable) {
                      lobs.push({ index: i, key: column, stream: row[column] });
                    }
                  }
                }
              }
            }
            Promise.each(lobs, function (lob) {
              return new Promise(function (lobResolve, lobReject) {

                readStream(lob.stream, function (err, d) {
                  if (err) {
                    if (results.resultSet) {
                      results.resultSet.close(function () {
                        return lobReject(err);
                      });
                    }
                    return lobReject(err);
                  }
                  results.rows[lob.index][lob.key] = d;
                  lobResolve();
                });
              });
            }).then(function () {
              if (results.resultSet) {
                results.resultSet.close(function (err) {
                  if (err) {
                    return resultReject(err);
                  }
                  return resultResolve(results);
                });
              }
              resultResolve(results);
            }, function (err) {
              resultReject(err);
            });
          });
        });
      };
      resolver(connection);
    });
  });
  return asyncConnection;
};

// Used to explicitly close a connection, called internally by the pool
// when a connection times out or the pool is shutdown.
Client_Oracledb.prototype.destroyRawConnection = function (connection, cb) {
  connection.release(cb);
};

// Runs the query on the specified connection, providing the bindings
// and any other necessary prep work.
Client_Oracledb.prototype._query = function (connection, obj) {
  // Convert ? params into positional bindings (:1)
  obj.sql = this.positionBindings(obj.sql);
  obj.bindings = this.prepBindings(obj.bindings) || [];

  return new Promise(function (resolver, rejecter) {
    if (!obj.sql) {
      return rejecter(new Error('The query is empty'));
    }
    var options = { autoCommit: false };
    if (obj.method === 'select') {
      options.resultSet = true;
    }
    connection.executeAsync(obj.sql, obj.bindings, options).then(function (response) {
      // Flatten outBinds
      var outBinds = _.flatten(response.outBinds);
      obj.response = response.rows || [];
      obj.rowsAffected = response.rows ? response.rows.rowsAffected : response.rowsAffected;

      if (obj.method === 'update') {
        var modifiedRowsCount = obj.rowsAffected.length || obj.rowsAffected;
        var updatedObjOutBinding = [];
        var updatedOutBinds = [];
        var updateOutBinds = function updateOutBinds(value, index) {
          OutBindsOffset = index * modifiedRowsCount;
          updatedOutBinds.push(outBinds[i + OutBindsOffset]);
        };

        for (var i = 0; i < modifiedRowsCount; i++) {
          updatedObjOutBinding.push(obj.outBinding[0]);
          var OutBindsOffset = 0;
          _.each(obj.outBinding[0], updateOutBinds);
        }
        outBinds = updatedOutBinds;
        obj.outBinding = updatedObjOutBinding;
      }

      if (!obj.returning && outBinds.length === 0) {
        return connection.commitAsync().then(function () {
          resolver(obj);
        });
      }
      var rowIds = [];
      var offset = 0;
      Promise.each(obj.outBinding, function (ret, line) {
        offset = offset + (obj.outBinding[line - 1] ? obj.outBinding[line - 1].length : 0);
        return Promise.each(ret, function (out, index) {
          return new Promise(function (bindResolver, bindRejecter) {
            if (out instanceof BlobHelper) {
              var blob = outBinds[index + offset];
              if (out.returning) {
                obj.response[line] = obj.response[line] || {};
                obj.response[line][out.columnName] = out.value;
              }
              blob.on('error', function (err) {
                bindRejecter(err);
              });
              blob.on('finish', function () {
                bindResolver();
              });
              blob.write(out.value);
              blob.end();
            } else if (obj.outBinding[line][index] === 'ROWID') {
              rowIds.push(outBinds[index + offset]);
              bindResolver();
            } else {
              obj.response[line] = obj.response[line] || {};
              obj.response[line][out] = outBinds[index + offset];
              bindResolver();
            }
          });
        });
      }).then(function () {
        return connection.commitAsync();
      }).then(function () {
        if (obj.returningSql) {
          return connection.executeAsync(obj.returningSql(), rowIds, { resultSet: true }).then(function (response) {
            obj.response = response.rows;
            return obj;
          }, rejecter);
        }
        return obj;
      }, rejecter).then(function (obj) {
        resolver(obj);
      });
    }, rejecter);
  });
};

// Handle clob
function readStream(stream, cb) {
  var oracledb = require('oracledb');
  var data = '';

  if (stream.iLob.type === oracledb.CLOB) {
    stream.setEncoding('utf-8');
  } else {
    data = new Buffer(0);
  }
  stream.on('error', function (err) {
    cb(err);
  });
  stream.on('data', function (chunk) {
    if (stream.iLob.type === oracledb.CLOB) {
      data += chunk;
    } else {
      data = Buffer.concat([data, chunk]);
    }
  });
  stream.on('end', function () {
    cb(null, data);
  });
}

// Process the response as returned from the query.
Client_Oracledb.prototype.processResponse = function (obj, runner) {
  var response = obj.response;
  var method = obj.method;
  if (obj.output) {
    return obj.output.call(runner, response);
  }
  switch (method) {
    case 'select':
    case 'pluck':
    case 'first':
      response = helpers.skim(response);
      if (obj.method === 'pluck') response = _.pluck(response, obj.pluck);
      return obj.method === 'first' ? response[0] : response;
    case 'insert':
    case 'del':
    case 'update':
    case 'counter':
      if (obj.returning) {
        if (obj.returning.length === 1 && obj.returning[0] !== '*') {
          return _.flatten(_.map(response, _.values));
        }
        return response;
      } else if (!_.isUndefined(obj.rowsAffected)) {
        return obj.rowsAffected;
      } else {
        return 1;
      }
      break;
    default:
      return response;
  }
};

module.exports = Client_Oracledb;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kaWFsZWN0cy9vcmFjbGVkYi9pbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUdBLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMxQixJQUFJLFFBQVEsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDbkMsSUFBSSxhQUFhLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQ3pDLElBQUksYUFBYSxHQUFHLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBQ2hELElBQUksY0FBYyxHQUFHLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO0FBQ3hELElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUN2QyxJQUFJLFVBQVUsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsVUFBVSxDQUFDO0FBQy9DLElBQUksZUFBZSxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxlQUFlLENBQUM7QUFDekQsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3ZDLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMvQixJQUFJLE9BQU8sR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDdkMsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDOztBQUUzQyxTQUFTLGVBQWUsR0FBRztBQUN6QixlQUFhLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQzs7QUFFckMsTUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO0FBQ2YsV0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLENBQUMsQ0FBQztBQUNyRSxXQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLElBQUksQ0FB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b3VyY2VzQ29udGVudCI6WyJcbi8vIE9yYWNsZWRiIENsaWVudFxuLy8gLS0tLS0tLVxudmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7XG52YXIgQ2xpZW50X09yYWNsZSA9IHJlcXVpcmUoJy4uL29yYWNsZScpO1xudmFyIFF1ZXJ5Q29tcGlsZXIgPSByZXF1aXJlKCcuL3F1ZXJ5L2NvbXBpbGVyJyk7XG52YXIgQ29sdW1uQ29tcGlsZXIgPSByZXF1aXJlKCcuL3NjaGVtYS9jb2x1bW5jb21waWxlcicpO1xudmFyIEZvcm1hdHRlciA9IHJlcXVpcmUoJy4vZm9ybWF0dGVyJyk7XG52YXIgQmxvYkhlbHBlciA9IHJlcXVpcmUoJy4vdXRpbHMnKS5CbG9iSGVscGVyO1xudmFyIFJldHVybmluZ0hlbHBlciA9IHJlcXVpcmUoJy4vdXRpbHMnKS5SZXR1cm5pbmdIZWxwZXI7XG52YXIgUHJvbWlzZSA9IHJlcXVpcmUoJy4uLy4uL3Byb21pc2UnKTtcbnZhciBzdHJlYW0gPSByZXF1aXJlKCdzdHJlYW0nKTtcbnZhciBoZWxwZXJzID0gcmVxdWlyZSgnLi4vLi4vaGVscGVycycpO1xudmFyIFRyYW5zYWN0aW9uID0gcmVxdWlyZSgnLi90cmFuc2FjdGlvbicpO1xuXG5mdW5jdGlvbiBDbGllbnRfT3JhY2xlZGIoKSB7XG4gIENsaWVudF9PcmFjbGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgLy8gTm9kZS5qcyBvbmx5IGhhdmUgNCBiYWNrZ3JvdW5kIHRocmVhZHMgYnkgZGVmYXVsdCwgb3JhY2xlZGIgbmVlZHMgb25lIGJ5IGNvbm5lY3Rpb25cbiAgaWYgKHRoaXMuZHJpdmVyKSB7XG4gICAgcHJvY2Vzcy5lbnYuVVZfVEhSRUFEUE9PTF9TSVpFID0gcHJvY2Vzcy5lbnYuVVZfVEhSRUFEUE9PTF9TSVpFIHx8IDE7XG4gICAgcHJvY2Vzcy5lbnYuVVZfVEhSRUFEUE9PTF9TSVpFICs9IHRoaXMuZHJpdmVyLnBvb2xNYXg7XG4gIH1cbn1cbmluaGVyaXRzKENsaWVudF9PcmFjbGVkYiwgQ2xpZW50X09yYWNsZSk7XG5cbkNsaWVudF9PcmFjbGVkYi5wcm90b3R5cGUuZHJpdmVyTmFtZSA9ICdvcmFjbGVkYic7XG5cbkNsaWVudF9PcmFjbGVkYi5wcm90b3R5cGUuX2RyaXZlciA9IGZ1bmN0aW9uKCkge1xuICB2YXIgb3JhY2xlZGIgPSByZXF1aXJlKCdvcmFjbGVkYicpO1xuICByZXR1cm4gb3JhY2xlZGI7XG59O1xuXG5DbGllbnRfT3JhY2xlZGIucHJvdG90eXBlLlF1ZXJ5Q29tcGlsZXIgPSBRdWVyeUNvbXBpbGVyO1xuQ2xpZW50X09yYWNsZWRiLnByb3RvdHlwZS5Db2x1bW5Db21waWxlciA9IENvbHVtbkNvbXBpbGVyO1xuQ2xpZW50X09yYWNsZWRiLnByb3RvdHlwZS5Gb3JtYXR0ZXIgPSBGb3JtYXR0ZXI7XG5DbGllbnRfT3JhY2xlZGIucHJvdG90eXBlLlRyYW5zYWN0aW9uID0gVHJhbnNhY3Rpb247XG5cbkNsaWVudF9PcmFjbGVkYi5wcm90b3R5cGUucHJlcEJpbmRpbmdzID0gZnVuY3Rpb24oYmluZGluZ3MpIHtcbiAgdmFyIHNlbGYgPSB0aGlzO1xuICByZXR1cm4gXy5tYXAoYmluZGluZ3MsIGZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQmxvYkhlbHBlciAmJiBzZWxmLmRyaXZlcikge1xuICAgICAgcmV0dXJuIHt0eXBlOiBzZWxmLmRyaXZlci5CTE9CLCBkaXI6IHNlbGYuZHJpdmVyLkJJTkRfT1VUfTtcbiAgICAgIC8vIFJldHVybmluZyBoZWxwZXIgYWx3YXlzIHVzZSBST1dJRCBhcyBzdHJpbmdcbiAgICB9IGVsc2UgaWYgKHZhbHVlIGluc3RhbmNlb2YgUmV0dXJuaW5nSGVscGVyICYmIHNlbGYuZHJpdmVyKSB7XG4gICAgICByZXR1cm4ge3R5cGU6IHNlbGYuZHJpdmVyLlNUUklORywgZGlyOiBzZWxmLmRyaXZlci5CSU5EX09VVH07XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJykge1xuICAgICAgcmV0dXJuIHZhbHVlID8gMSA6IDA7XG4gICAgfVxuICAgIHJldHVybiB2YWx1ZTtcbiAgfSk7XG59O1xuXG4vLyBHZXQgYSByYXcgY29ubmVjdGlvbiwgY2FsbGVkIGJ5IHRoZSBgcG9vbGAgd2hlbmV2ZXIgYSBuZXdcbi8vIGNvbm5lY3Rpb24gbmVlZHMgdG8gYmUgYWRkZWQgdG8gdGhlIHBvb2wuXG5DbGllbnRfT3JhY2xlZGIucHJvdG90eXBlLmFjcXVpcmVSYXdDb25uZWN0aW9uID0gZnVuY3Rpb24oKSB7XG4gIHZhciBjbGllbnQgPSB0aGlzO1xuICB2YXIgYXN5bmNDb25uZWN0aW9uID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZXIsIHJlamVjdGVyKSB7XG4gICAgY2xpZW50LmRyaXZlci5nZXRDb25uZWN0aW9uKHtcbiAgICAgIHVzZXI6IGNsaWVudC5jb25uZWN0aW9uU2V0dGluZ3MudXNlcixcbiAgICAgIHBhc3N3b3JkOiBjbGllbnQuY29ubmVjdGlvblNldHRpbmdzLnBhc3N3b3JkLFxuICAgICAgY29ubmVjdFN0cmluZzogY2xpZW50LmNvbm5lY3Rpb25TZXR0aW5ncy5ob3N0ICsgJy8nICsgY2xpZW50LmNvbm5lY3Rpb25TZXR0aW5ncy5kYXRhYmFzZVxuICAgIH0sIGZ1bmN0aW9uKGVyciwgY29ubmVjdGlvbikge1xuICAgICAgaWYgKGVycilcbiAgICAgICAgcmV0dXJuIHJlamVjdGVyKGVycik7XG4gICAgICBpZiAoY2xpZW50LmNvbm5lY3Rpb25TZXR0aW5ncy5wcmVmZXRjaFJvd0NvdW50KSB7XG4gICAgICAgIGNvbm5lY3Rpb24uc2V0UHJlZmV0Y2hSb3dDb3VudChjbGllbnQuY29ubmVjdGlvblNldHRpbmdzLnByZWZldGNoUm93Q291bnQpO1xuICAgICAgfVxuXG4gICAgICBjb25uZWN0aW9uLmNvbW1pdEFzeW5jID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciBzZWxmID0gdGhpcztcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKGNvbW1pdFJlc29sdmUsIGNvbW1pdFJlamVjdCkge1xuICAgICAgICAgIGlmIChjb25uZWN0aW9uLmlzVHJhbnNhY3Rpb24pIHtcbiAgICAgICAgICAgIHJldHVybiBjb21taXRSZXNvbHZlKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHNlbGYuY29tbWl0KGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICByZXR1cm4gY29tbWl0UmVqZWN0KGVycik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb21taXRSZXNvbHZlKCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfTtcbiAgICAgIGNvbm5lY3Rpb24ucm9sbGJhY2tBc3luYyA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyb2xsYmFja1Jlc29sdmUsIHJvbGxiYWNrUmVqZWN0KSB7XG4gICAgICAgICAgc2VsZi5yb2xsYmFjayhmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHJvbGxiYWNrUmVqZWN0KGVycik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByb2xsYmFja1Jlc29sdmUoKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9O1xuICAgICAgdmFyIGZldGNoQXN5bmMgPSBmdW5jdGlvbihzcWwsIGJpbmRQYXJhbXMsIG9wdGlvbnMsIGNiKSB7XG4gICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgICAgICBvcHRpb25zLm91dEZvcm1hdCA9IGNsaWVudC5kcml2ZXIuT0JKRUNUO1xuICAgICAgICBpZiAob3B0aW9ucy5yZXN1bHRTZXQpIHtcbiAgICAgICAgICBjb25uZWN0aW9uLmV4ZWN1dGUoc3FsLCBiaW5kUGFyYW1zIHx8IFtdLCBvcHRpb25zLCBmdW5jdGlvbihlcnIsIHJlc3VsdCkge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICByZXR1cm4gY2IoZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBmZXRjaFJlc3VsdCA9IHtyb3dzOiBbXSwgcmVzdWx0U2V0OiByZXN1bHQucmVzdWx0U2V0fTtcbiAgICAgICAgICAgIHZhciBudW1Sb3dzID0gMTAwO1xuICAgICAgICAgICAgdmFyIGZldGNoUm93c0Zyb21SUyA9IGZ1bmN0aW9uKGNvbm5lY3Rpb24sIHJlc3VsdFNldCwgbnVtUm93cykge1xuICAgICAgICAgICAgICByZXN1bHRTZXQuZ2V0Um93cyhudW1Sb3dzLCBmdW5jdGlvbihlcnIsIHJvd3MpIHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICByZXN1bHRTZXQuY2xvc2UoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjYihlcnIpO1xuICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyb3dzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIGNiKG51bGwsIGZldGNoUmVzdWx0KTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJvd3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgaWYgKHJvd3MubGVuZ3RoID09PSBudW1Sb3dzKSB7XG4gICAgICAgICAgICAgICAgICAgIGZldGNoUmVzdWx0LnJvd3MgPSBmZXRjaFJlc3VsdC5yb3dzLmNvbmNhdChyb3dzKTtcbiAgICAgICAgICAgICAgICAgICAgZmV0Y2hSb3dzRnJvbVJTKGNvbm5lY3Rpb24sIHJlc3VsdFNldCwgbnVtUm93cyk7XG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBmZXRjaFJlc3VsdC5yb3dzID0gZmV0Y2hSZXN1bHQucm93cy5jb25jYXQocm93cyk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjYihudWxsLCBmZXRjaFJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBmZXRjaFJvd3NGcm9tUlMoY29ubmVjdGlvbiwgcmVzdWx0LnJlc3VsdFNldCwgbnVtUm93cyk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29ubmVjdGlvbi5leGVjdXRlKHNxbCwgYmluZFBhcmFtcyB8fCBbXSwgb3B0aW9ucywgY2IpO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgICAgY29ubmVjdGlvbi5leGVjdXRlQXN5bmMgPSBmdW5jdGlvbihzcWwsIGJpbmRQYXJhbXMsIG9wdGlvbnMpIHtcbiAgICAgICAgLy8gUmVhZCBhbGwgbG9iXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXN1bHRSZXNvbHZlLCByZXN1bHRSZWplY3QpIHtcbiAgICAgICAgICBmZXRjaEFzeW5jKHNxbCwgYmluZFBhcmFtcywgb3B0aW9ucywgZnVuY3Rpb24oZXJyLCByZXN1bHRzKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgIHJldHVybiByZXN1bHRSZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIENvbGxlY3QgTE9CcyB0byByZWFkXG4gICAgICAgICAgICB2YXIgbG9icyA9IFtdO1xuICAgICAgICAgICAgaWYgKHJlc3VsdHMucm93cykge1xuICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHRzLnJvd3MpKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXN1bHRzLnJvd3MubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgIC8vIEl0ZXJhdGUgdGhyb3VnaCB0aGUgcm93c1xuICAgICAgICAgICAgICAgICAgdmFyIHJvdyA9IHJlc3VsdHMucm93c1tpXTtcbiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGNvbHVtbiBpbiByb3cpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJvd1tjb2x1bW5dIGluc3RhbmNlb2Ygc3RyZWFtLlJlYWRhYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgbG9icy5wdXNoKHtpbmRleDogaSwga2V5OiBjb2x1bW4sIHN0cmVhbTogcm93W2NvbHVtbl19KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgUHJvbWlzZS5lYWNoKGxvYnMsIGZ1bmN0aW9uKGxvYikge1xuICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24obG9iUmVzb2x2ZSwgbG9iUmVqZWN0KSB7XG5cbiAgICAgICAgICAgICAgICByZWFkU3RyZWFtKGxvYi5zdHJlYW0sIGZ1bmN0aW9uKGVyciwgZCkge1xuICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0cy5yZXN1bHRTZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnJlc3VsdFNldC5jbG9zZShmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsb2JSZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbG9iUmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICByZXN1bHRzLnJvd3NbbG9iLmluZGV4XVtsb2Iua2V5XSA9IGQ7XG4gICAgICAgICAgICAgICAgICBsb2JSZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdHMucmVzdWx0U2V0KSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0cy5yZXN1bHRTZXQuY2xvc2UoZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRSZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRSZXNvbHZlKHJlc3VsdHMpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHJlc3VsdFJlc29sdmUocmVzdWx0cyk7XG4gICAgICAgICAgICB9LCBmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgcmVzdWx0UmVqZWN0KGVycik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9O1xuICAgICAgcmVzb2x2ZXIoY29ubmVjdGlvbik7XG4gICAgfSk7XG4gIH0pO1xuICByZXR1cm4gYXN5bmNDb25uZWN0aW9uO1xufTtcblxuLy8gVXNlZCB0byBleHBsaWNpdGx5IGNsb3NlIGEgY29ubmVjdGlvbiwgY2FsbGVkIGludGVybmFsbHkgYnkgdGhlIHBvb2xcbi8vIHdoZW4gYSBjb25uZWN0aW9uIHRpbWVzIG91dCBvciB0aGUgcG9vbCBpcyBzaHV0ZG93bi5cbkNsaWVudF9PcmFjbGVkYi5wcm90b3R5cGUuZGVzdHJveVJhd0Nvbm5lY3Rpb24gPSBmdW5jdGlvbihjb25uZWN0aW9uLCBjYikge1xuICBjb25uZWN0aW9uLnJlbGVhc2UoY2IpO1xufTtcblxuLy8gUnVucyB0aGUgcXVlcnkgb24gdGhlIHNwZWNpZmllZCBjb25uZWN0aW9uLCBwcm92aWRpbmcgdGhlIGJpbmRpbmdzXG4vLyBhbmQgYW55IG90aGVyIG5lY2Vzc2FyeSBwcmVwIHdvcmsuXG5DbGllbnRfT3JhY2xlZGIucHJvdG90eXBlLl9xdWVyeSA9IGZ1bmN0aW9uKGNvbm5lY3Rpb24sIG9iaikge1xuICAvLyBDb252ZXJ0ID8gcGFyYW1zIGludG8gcG9zaXRpb25hbCBiaW5kaW5ncyAoOjEpXG4gIG9iai5zcWwgPSB0aGlzLnBvc2l0aW9uQmluZGluZ3Mob2JqLnNxbCk7XG4gIG9iai5iaW5kaW5ncyA9IHRoaXMucHJlcEJpbmRpbmdzKG9iai5iaW5kaW5ncykgfHwgW107XG5cbiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmVyLCByZWplY3Rlcikge1xuICAgIGlmICghb2JqLnNxbCkge1xuICAgICAgcmV0dXJuIHJlamVjdGVyKG5ldyBFcnJvcignVGhlIHF1ZXJ5IGlzIGVtcHR5JykpO1xuICAgIH1cbiAgICB2YXIgb3B0aW9ucyA9IHthdXRvQ29tbWl0OiBmYWxzZX07XG4gICAgaWYgKG9iai5tZXRob2QgPT09ICdzZWxlY3QnKSB7XG4gICAgICBvcHRpb25zLnJlc3VsdFNldCA9IHRydWU7XG4gICAgfVxuICAgIGNvbm5lY3Rpb24uZXhlY3V0ZUFzeW5jKG9iai5zcWwsIG9iai5iaW5kaW5ncywgb3B0aW9ucykudGhlbihmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgLy8gRmxhdHRlbiBvdXRCaW5kc1xuICAgICAgdmFyIG91dEJpbmRzID0gXy5mbGF0dGVuKHJlc3BvbnNlLm91dEJpbmRzKTtcbiAgICAgIG9iai5yZXNwb25zZSA9IHJlc3BvbnNlLnJvd3MgfHwgW107XG4gICAgICBvYmoucm93c0FmZmVjdGVkID0gcmVzcG9uc2Uucm93cyA/IHJlc3BvbnNlLnJvd3Mucm93c0FmZmVjdGVkIDogcmVzcG9uc2Uucm93c0FmZmVjdGVkO1xuXG4gICAgICBpZiAob2JqLm1ldGhvZCA9PT0gJ3VwZGF0ZScpIHtcbiAgICAgICAgdmFyIG1vZGlmaWVkUm93c0NvdW50ID0gb2JqLnJvd3NBZmZlY3RlZC5sZW5ndGggfHwgb2JqLnJvd3NBZmZlY3RlZDtcbiAgICAgICAgdmFyIHVwZGF0ZWRPYmpPdXRCaW5kaW5nID0gW107XG4gICAgICAgIHZhciB1cGRhdGVkT3V0QmluZHMgPSBbXTtcbiAgICAgICAgdmFyIHVwZGF0ZU91dEJpbmRzID0gZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7XG4gICAgICAgICAgT3V0QmluZHNPZmZzZXQgPSBpbmRleCAqIG1vZGlmaWVkUm93c0NvdW50O1xuICAgICAgICAgIHVwZGF0ZWRPdXRCaW5kcy5wdXNoKG91dEJpbmRzW2kgKyBPdXRCaW5kc09mZnNldF0pO1xuICAgICAgICB9O1xuXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbW9kaWZpZWRSb3dzQ291bnQ7IGkrKykge1xuICAgICAgICAgIHVwZGF0ZWRPYmpPdXRCaW5kaW5nLnB1c2gob2JqLm91dEJpbmRpbmdbMF0pO1xuICAgICAgICAgIHZhciBPdXRCaW5kc09mZnNldCA9IDA7XG4gICAgICAgICAgXy5lYWNoKG9iai5vdXRCaW5kaW5nWzBdLCB1cGRhdGVPdXRCaW5kcyk7XG4gICAgICAgIH1cbiAgICAgICAgb3V0QmluZHMgPSB1cGRhdGVkT3V0QmluZHM7XG4gICAgICAgIG9iai5vdXRCaW5kaW5nID0gdXBkYXRlZE9iak91dEJpbmRpbmc7XG4gICAgICB9XG5cbiAgICAgIGlmICghb2JqLnJldHVybmluZyAmJiBvdXRCaW5kcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIGNvbm5lY3Rpb24uY29tbWl0QXN5bmMoKS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgIHJlc29sdmVyKG9iaik7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgdmFyIHJvd0lkcyA9IFtdO1xuICAgICAgdmFyIG9mZnNldCA9IDA7XG4gICAgICBQcm9taXNlLmVhY2gob2JqLm91dEJpbmRpbmcsIGZ1bmN0aW9uKHJldCwgbGluZSkge1xuICAgICAgICBvZmZzZXQgPSBvZmZzZXQgKyAob2JqLm91dEJpbmRpbmdbbGluZSAtIDFdID8gb2JqLm91dEJpbmRpbmdbbGluZSAtIDFdLmxlbmd0aCA6IDApO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5lYWNoKHJldCwgZnVuY3Rpb24ob3V0LCBpbmRleCkge1xuICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihiaW5kUmVzb2x2ZXIsIGJpbmRSZWplY3Rlcikge1xuICAgICAgICAgICAgaWYgKG91dCBpbnN0YW5jZW9mIEJsb2JIZWxwZXIpIHtcbiAgICAgICAgICAgICAgdmFyIGJsb2IgPSBvdXRCaW5kc1tpbmRleCArIG9mZnNldF07XG4gICAgICAgICAgICAgIGlmIChvdXQucmV0dXJuaW5nKSB7XG4gICAgICAgICAgICAgICAgb2JqLnJlc3BvbnNlW2xpbmVdID0gb2JqLnJlc3BvbnNlW2xpbmVdIHx8IHt9O1xuICAgICAgICAgICAgICAgIG9iai5yZXNwb25zZVtsaW5lXVtvdXQuY29sdW1uTmFtZV0gPSBvdXQudmFsdWU7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgYmxvYi5vbignZXJyb3InLCBmdW5jdGlvbihlcnIpIHtcbiAgICAgICAgICAgICAgICBiaW5kUmVqZWN0ZXIoZXJyKTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIGJsb2Iub24oJ2ZpbmlzaCcsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIGJpbmRSZXNvbHZlcigpO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgYmxvYi53cml0ZShvdXQudmFsdWUpO1xuICAgICAgICAgICAgICBibG9iLmVuZCgpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChvYmoub3V0QmluZGluZ1tsaW5lXVtpbmRleF0gPT09ICdST1dJRCcpIHtcbiAgICAgICAgICAgICAgcm93SWRzLnB1c2gob3V0QmluZHNbaW5kZXggKyBvZmZzZXRdKTtcbiAgICAgICAgICAgICAgYmluZFJlc29sdmVyKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBvYmoucmVzcG9uc2VbbGluZV0gPSBvYmoucmVzcG9uc2VbbGluZV0gfHwge307XG4gICAgICAgICAgICAgIG9iai5yZXNwb25zZVtsaW5lXVtvdXRdID0gb3V0QmluZHNbaW5kZXggKyBvZmZzZXRdO1xuICAgICAgICAgICAgICBiaW5kUmVzb2x2ZXIoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9KS50aGVuKGZ1bmN0aW9uKCkge1xuICAgICAgICAgIHJldHVybiBjb25uZWN0aW9uLmNvbW1pdEFzeW5jKCk7XG4gICAgICAgIH0pLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmIChvYmoucmV0dXJuaW5nU3FsKSB7XG4gICAgICAgICAgICByZXR1cm4gY29ubmVjdGlvbi5leGVjdXRlQXN5bmMob2JqLnJldHVybmluZ1NxbCgpLCByb3dJZHMsIHtyZXN1bHRTZXQ6IHRydWV9KVxuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgb2JqLnJlc3BvbnNlID0gcmVzcG9uc2Uucm93cztcbiAgICAgICAgICAgICAgcmV0dXJuIG9iajtcbiAgICAgICAgICAgIH0sIHJlamVjdGVyKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gb2JqO1xuICAgICAgfSwgcmVqZWN0ZXIpXG4gICAgICAgIC50aGVuKGZ1bmN0aW9uKG9iaikge1xuICAgICAgICAgIHJlc29sdmVyKG9iaik7XG4gICAgICAgIH0pO1xuICAgIH0sIHJlamVjdGVyKTtcbiAgfSk7XG59O1xuXG4vLyBIYW5kbGUgY2xvYlxuZnVuY3Rpb24gcmVhZFN0cmVhbShzdHJlYW0sIGNiKSB7XG4gIHZhciBvcmFjbGVkYiA9IHJlcXVpcmUoJ29yYWNsZWRiJyk7XG4gIHZhciBkYXRhID0gJyc7XG5cbiAgaWYgKHN0cmVhbS5pTG9iLnR5cGUgPT09IG9yYWNsZWRiLkNMT0IpIHtcbiAgICBzdHJlYW0uc2V0RW5jb2RpbmcoJ3V0Zi04Jyk7XG4gIH0gZWxzZSB7XG4gICAgZGF0YSA9IG5ldyBCdWZmZXIoMCk7XG4gIH1cbiAgc3RyZWFtLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGVycikge1xuICAgIGNiKGVycik7XG4gIH0pO1xuICBzdHJlYW0ub24oJ2RhdGEnLCBmdW5jdGlvbihjaHVuaykge1xuICAgIGlmIChzdHJlYW0uaUxvYi50eXBlID09PSBvcmFjbGVkYi5DTE9CKSB7XG4gICAgICBkYXRhICs9IGNodW5rO1xuICAgIH0gZWxzZSB7XG4gICAgICBkYXRhID0gQnVmZmVyLmNvbmNhdChbZGF0YSwgY2h1bmtdKTtcbiAgICB9XG4gIH0pO1xuICBzdHJlYW0ub24oJ2VuZCcsIGZ1bmN0aW9uKCkge1xuICAgIGNiKG51bGwsIGRhdGEpO1xuICB9KTtcbn1cblxuLy8gUHJvY2VzcyB0aGUgcmVzcG9uc2UgYXMgcmV0dXJuZWQgZnJvbSB0aGUgcXVlcnkuXG5DbGllbnRfT3JhY2xlZGIucHJvdG90eXBlLnByb2Nlc3NSZXNwb25zZSA9IGZ1bmN0aW9uKG9iaiwgcnVubmVyKSB7XG4gIHZhciByZXNwb25zZSA9IG9iai5yZXNwb25zZTtcbiAgdmFyIG1ldGhvZCA9IG9iai5tZXRob2Q7XG4gIGlmIChvYmoub3V0cHV0KSB7XG4gICAgcmV0dXJuIG9iai5vdXRwdXQuY2FsbChydW5uZXIsIHJlc3BvbnNlKTtcbiAgfVxuICBzd2l0Y2ggKG1ldGhvZCkge1xuICAgIGNhc2UgJ3NlbGVjdCc6XG4gICAgY2FzZSAncGx1Y2snOlxuICAgIGNhc2UgJ2ZpcnN0JzpcbiAgICAgIHJlc3BvbnNlID0gaGVscGVycy5za2ltKHJlc3BvbnNlKTtcbiAgICAgIGlmIChvYmoubWV0aG9kID09PSAncGx1Y2snKVxuICAgICAgICByZXNwb25zZSA9IF8ucGx1Y2socmVzcG9uc2UsIG9iai5wbHVjayk7XG4gICAgICByZXR1cm4gb2JqLm1ldGhvZCA9PT0gJ2ZpcnN0JyA/IHJlc3BvbnNlWzBdIDogcmVzcG9uc2U7XG4gICAgY2FzZSAnaW5zZXJ0JzpcbiAgICBjYXNlICdkZWwnOlxuICAgIGNhc2UgJ3VwZGF0ZSc6XG4gICAgY2FzZSAnY291bnRlcic6XG4gICAgICBpZiAob2JqLnJldHVybmluZykge1xuICAgICAgICBpZiAob2JqLnJldHVybmluZy5sZW5ndGggPT09IDEgJiYgb2JqLnJldHVybmluZ1swXSAhPT0gJyonKSB7XG4gICAgICAgICAgcmV0dXJuIF8uZmxhdHRlbihfLm1hcChyZXNwb25zZSwgXy52YWx1ZXMpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgICB9IGVsc2UgaWYgKCFfLmlzVW5kZWZpbmVkKG9iai5yb3dzQWZmZWN0ZWQpKSB7XG4gICAgICAgIHJldHVybiBvYmoucm93c0FmZmVjdGVkO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIDE7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICB9XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IENsaWVudF9PcmFjbGVkYjtcbiJdfQ==