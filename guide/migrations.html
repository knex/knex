<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Migrations | Knex.js</title>
    <meta name="description" content="Beta knex.js documentation.">
    <link rel="stylesheet" href="/assets/style.a21b8e16.css">
    <link rel="modulepreload" href="/assets/chunks/AlgoliaSearchBox.a88cc1e3.js">
    <link rel="modulepreload" href="/assets/chunks/AlgoliaSearchBox.639416b3.js">
    <link rel="modulepreload" href="/assets/app.36cb52e5.js">
    <link rel="modulepreload" href="/assets/guide_migrations.md.a3b60bcd.lean.js">
    
    <link rel="icon" type="image/png" href="/knex-logo.png">
  <meta name="twitter:title" content="Migrations | Knex.js">
  <meta property="og:title" content="Migrations | Knex.js">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="Knex.js, back to home" data-v-675d8756 data-v-cc01ef16><img class="logo" src="/knex-logo.png" alt="Logo" data-v-cc01ef16> Knex.js</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/guide/" data-v-b8818f8c>Guide <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/faq/" data-v-b8818f8c>F.A.Q. <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/changelog.html" data-v-b8818f8c>Changelog <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/knex/knex" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--[--><select class="sql-dropdown item nav-link"><option value="mysql" selected>MySQL / MariaDB</option><option value="mysql2">MySQL2</option><option value="postgres">PostgreSQL</option><option value="pgnative">PG Native</option><option value="cockroachdb">CockroachDB</option><option value="redshift">Amazon Redshift</option><option value="sqlite3">SQLite3</option><option value="oracledb">OracleDB</option><option value="mssql">MSSQL</option></select><div class="algolia-search-box" id="docsearch"></div><a class="toggle-dark" tabindex="0" role="button" data-v-2a5e0da6><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--ph" width="32" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 256" data-v-2a5e0da6><circle cx="128" cy="128" r="60" fill="currentColor" opacity=".2" data-v-2a5e0da6></circle><path fill="currentColor" d="M128 60a68 68 0 1 0 68 68a68.1 68.1 0 0 0-68-68Zm0 120a52 52 0 1 1 52-52a52 52 0 0 1-52 52Zm-8-144V16a8 8 0 0 1 16 0v20a8 8 0 0 1-16 0ZM43.1 54.5a8.1 8.1 0 1 1 11.4-11.4l14.1 14.2a8 8 0 0 1 0 11.3a8.1 8.1 0 0 1-11.3 0ZM36 136H16a8 8 0 0 1 0-16h20a8 8 0 0 1 0 16Zm32.6 51.4a8 8 0 0 1 0 11.3l-14.1 14.2a8.3 8.3 0 0 1-5.7 2.3a8.5 8.5 0 0 1-5.7-2.3a8.1 8.1 0 0 1 0-11.4l14.2-14.1a8 8 0 0 1 11.3 0ZM136 220v20a8 8 0 0 1-16 0v-20a8 8 0 0 1 16 0Zm76.9-18.5a8.1 8.1 0 0 1 0 11.4a8.5 8.5 0 0 1-5.7 2.3a8.3 8.3 0 0 1-5.7-2.3l-14.1-14.2a8 8 0 0 1 11.3-11.3ZM248 128a8 8 0 0 1-8 8h-20a8 8 0 0 1 0-16h20a8 8 0 0 1 8 8Zm-60.6-59.4a8 8 0 0 1 0-11.3l14.1-14.2a8.1 8.1 0 0 1 11.4 11.4l-14.2 14.1a8.1 8.1 0 0 1-11.3 0Z" data-v-2a5e0da6></path></svg></a><!--]--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item active" href="/guide/" data-v-b8818f8c>Guide <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/faq/" data-v-b8818f8c>F.A.Q. <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/changelog.html" data-v-b8818f8c>Changelog <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/knex/knex" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/">Installation</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/query-builder">Query Builder</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/transactions">Transactions</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/schema-builder">Schema Builder</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/raw">Raw</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/ref">Ref</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/utility">Utility</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/interfaces">Interfaces</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/guide/migrations">Migrations</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#migration-cli">Migration CLI</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#seed-files">Seed files</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#seed-cli">Seed CLI</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#knexfile-js">knexfile.js</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#basic-configuration">Basic configuration</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#environment-configuration">Environment configuration</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#custom-migration">Custom migration</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#custom-migration-name">Custom migration name</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#generated-migration-extension">Generated migration extension</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#knexfile-in-other-languages">Knexfile in other languages</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#migration-api">Migration API</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#transactions-in-migrations">Transactions in migrations</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#make">make</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#latest">latest</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#rollback">rollback</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#up">up</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#down">down</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#currentversion">currentVersion</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#list">list</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#unlock">unlock</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#notes-about-locks">Notes about locks</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#custom-migration-sources">Custom migration sources</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#webpack-migration-source-example">Webpack migration source example</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#ecmascript-modules-esm-interoperability">ECMAScript modules (ESM) Interoperability</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#seed-api">Seed API</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#make-1">make</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#run">run</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#custom-seed-sources">Custom seed sources</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/guide/extending">Extending</a><!----></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="migrations" tabindex="-1">Migrations <a class="header-anchor" href="#migrations" aria-hidden="true">#</a></h1><p>Migrations allow for you to define sets of schema changes so upgrading a database is a breeze.</p><h2 id="migration-cli" tabindex="-1">Migration CLI <a class="header-anchor" href="#migration-cli" aria-hidden="true">#</a></h2><p>The migration CLI is bundled with the knex install, and is driven by the <a href="https://github.com/tkellen/node-liftoff" target="_blank" rel="noopener noreferrer">node-liftoff</a> module. To install globally, run:</p><div class="language-bash"><pre><code>$ <span class="token function">npm</span> <span class="token function">install</span> knex <span class="token parameter variable">-g</span>
</code></pre></div><p>The migration CLI accepts the following general command-line options. You can view help text and additional options for each command using <code>--help</code>. E.g. <code>knex migrate:latest --help</code>.</p><ul><li><code>--debug</code>: Run with debugging</li><li><code>--knexfile [path]</code>: Specify the knexfile path</li><li><code>--knexpath [path]</code>: Specify the path to the knex instance</li><li><code>--cwd [path]</code>: Specify the working directory</li><li><code>--client [name]</code>: Set the DB client</li><li><code>--connection [address]</code>: Set the DB connection</li><li><code>--migrations-table-name</code>: Set the migration table name</li><li><code>--migrations-directory</code>: Set the migrations directory</li><li><code>--env</code>: environment, default: <code>process.<wbr>env.NODE_ENV || development</code></li><li><code>--esm</code>: <a href="#ecmascript-modules-esm-interoperability">Enables ESM module interoperability</a></li><li><code>--help</code>: Display help text for a particular command and exit.</li></ul><p>Migrations use a <strong>knexfile</strong>, which specify various configuration settings for the module. To create a new knexfile, run the following:</p><div class="language-bash"><pre><code>$ knex init

<span class="token comment"># or for .ts</span>

$ knex init <span class="token parameter variable">-x</span> ts
</code></pre></div><p>will create a sample knexfile.js - the file which contains our various database configurations. Once you have a knexfile.js, you can use the migration tool to create migration files to the specified directory (default migrations). Creating new migration files can be achieved by running:</p><div class="language-bash"><pre><code>$ knex migrate:make migration_name

<span class="token comment"># or for .ts</span>

$ knex migrate:make migration_name <span class="token parameter variable">-x</span> ts
</code></pre></div><ul><li>you can also create your migration using a specific stub file, this serves as a migration template to speed up development for common migration operations</li><li>if the --stub option is not passed, the CLI will use either the knex default stub for the chosen extension, or the config.stub file</li></ul><div class="language-bash"><pre><code>$ knex migrate:make <span class="token parameter variable">--stub</span>

<span class="token comment"># or</span>

$ knex migrate:make <span class="token parameter variable">--stub</span>
</code></pre></div><ul><li>if a stub path is provided, it must be relative to the knexfile.[js, ts, etc] location</li><li>if a is used, the stub is selected by its file name. The CLI will look for this file in the config.migrations.directory folder. If the config.migrations.directory is not defined, this operation will fail</li></ul><p>Once you have finished writing the migrations, you can update the database matching your <code>NODE_ENV</code> by running:</p><div class="language-bash"><pre><code>$ knex migrate:latest
</code></pre></div><p>You can also pass the <code>--env</code> flag or set <code>NODE_ENV</code> to select an alternative environment:</p><div class="language-bash"><pre><code>$ knex migrate:latest <span class="token parameter variable">--env</span> production

<span class="token comment"># or</span>

$ <span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>production knex migrate:latest
</code></pre></div><p>To rollback the last batch of migrations:</p><div class="language-bash"><pre><code>$ knex migrate:rollback
</code></pre></div><p>To rollback all the completed migrations:</p><div class="language-bash"><pre><code>$ knex migrate:rollback <span class="token parameter variable">--all</span>
</code></pre></div><p>To run the next migration that has not yet been run</p><div class="language-bash"><pre><code>$ knex migrate:up
</code></pre></div><p>To run the specified migration that has not yet been run</p><div class="language-bash"><pre><code>$ knex migrate:up 001_migration_name.js
</code></pre></div><p>To undo the last migration that was run</p><div class="language-bash"><pre><code>$ knex migrate:down
</code></pre></div><p>To undo the specified migration that was run</p><div class="language-bash"><pre><code>$ knex migrate:down 001_migration_name.js
</code></pre></div><p>To list both completed and pending migrations:</p><div class="language-bash"><pre><code>$ knex migrate:list
</code></pre></div><h2 id="seed-files" tabindex="-1">Seed files <a class="header-anchor" href="#seed-files" aria-hidden="true">#</a></h2><p>Seed files allow you to populate your database with test or seed data independent of your migration files.</p><h3 id="seed-cli" tabindex="-1">Seed CLI <a class="header-anchor" href="#seed-cli" aria-hidden="true">#</a></h3><p>To create a seed file, run:</p><div class="language-bash"><pre><code>$ knex seed:make seed_name
</code></pre></div><p>Seed files are created in the directory specified in your knexfile.js for the current environment. A sample seed configuration looks like:</p><div class="language-js"><pre><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token literal-property property">development</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">/* ... */</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">connection</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">/* ... */</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">seeds</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">directory</span><span class="token operator">:</span> <span class="token string">&#39;./seeds/dev&#39;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>If no <code>seeds.directory</code> is defined, files are created in <code>./seeds</code>. Note that the seed directory needs to be a relative path. Absolute paths are not supported (nor is it good practice).</p><p>To run seed files, execute:</p><div class="language-bash"><pre><code>$ knex seed:run
</code></pre></div><p>Seed files are executed in alphabetical order. Unlike migrations, <em>every</em> seed file will be executed when you run the command. You should design your seed files to reset tables as needed before inserting data.</p><p>To run specific seed files, execute:</p><div class="language-bash"><pre><code>$ knex seed:run <span class="token parameter variable">--specific</span><span class="token operator">=</span>seed-filename.js <span class="token parameter variable">--specific</span><span class="token operator">=</span>another-seed-filename.js
</code></pre></div><h2 id="knexfile-js" tabindex="-1">knexfile.js <a class="header-anchor" href="#knexfile-js" aria-hidden="true">#</a></h2><p>A knexfile.js generally contains all of the configuration for your database. It can optionally provide different configuration for different environments. You may pass a <code>--knexfile</code> option to any of the command line statements to specify an alternate path to your knexfile.</p><h3 id="basic-configuration" tabindex="-1">Basic configuration <a class="header-anchor" href="#basic-configuration" aria-hidden="true">#</a></h3><div class="language-js"><pre><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token string">&#39;pg&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">connection</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DATABASE_URL</span> <span class="token operator">||</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">&#39;me&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">&#39;my_app&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>You can also use an async function to get connection details for your configuration. This is useful when you need to fetch credentials from a secure location like vault.</p><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">getPassword</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// TODO: implement me</span>
  <span class="token keyword">return</span> <span class="token string">&#39;my_pass&#39;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token string">&#39;pg&#39;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">connection</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> password <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">&#39;me&#39;</span><span class="token punctuation">,</span> password <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">migrations</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="environment-configuration" tabindex="-1">Environment configuration <a class="header-anchor" href="#environment-configuration" aria-hidden="true">#</a></h3><div class="language-js"><pre><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">development</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token string">&#39;pg&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">connection</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">&#39;me&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">&#39;my_app&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">production</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token string">&#39;pg&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">connection</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DATABASE_URL</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="custom-migration" tabindex="-1">Custom migration <a class="header-anchor" href="#custom-migration" aria-hidden="true">#</a></h3><p>You may provide a custom migration stub to be used in place of the default option.</p><div class="language-js"><pre><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token string">&#39;pg&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">migrations</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">stub</span><span class="token operator">:</span> <span class="token string">&#39;migration.stub&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="custom-migration-name" tabindex="-1">Custom migration name <a class="header-anchor" href="#custom-migration-name" aria-hidden="true">#</a></h3><p>You may provide a custom migration name to be used in place of the default option.</p><div class="language-js"><pre><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token string">&#39;pg&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">migrations</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">getNewMigrationName</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="generated-migration-extension" tabindex="-1">Generated migration extension <a class="header-anchor" href="#generated-migration-extension" aria-hidden="true">#</a></h3><p>You can control extension of generated migrations.</p><div class="language-js"><pre><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token string">&#39;pg&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">migrations</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">extension</span><span class="token operator">:</span> <span class="token string">&#39;ts&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="knexfile-in-other-languages" tabindex="-1">Knexfile in other languages <a class="header-anchor" href="#knexfile-in-other-languages" aria-hidden="true">#</a></h3><p>Knex uses <a href="https://github.com/js-cli/js-liftoff" target="_blank" rel="noopener noreferrer">Liftoff</a> to support knexfile written in other compile-to-js languages.</p><p>Depending on the language, this may require you to install additional dependencies. The complete list of dependencies for each supported language can be found <a href="https://github.com/gulpjs/interpret#extensions" target="_blank" rel="noopener noreferrer">here</a>.</p><p>Most common cases are typescript (for which <a href="https://www.npmjs.com/package/typescript" target="_blank" rel="noopener noreferrer">typescript</a> and <a href="https://www.npmjs.com/package/ts-node" target="_blank" rel="noopener noreferrer">ts-node</a> packages are recommended), and coffeescript (for which <a href="https://www.npmjs.com/package/coffeescript" target="_blank" rel="noopener noreferrer">coffeescript</a> dependency is required).</p><p>If you don&#39;t specify the extension explicitly, the extension of generated migrations/seed files will be inferred from the knexfile extension</p><h2 id="migration-api" tabindex="-1">Migration API <a class="header-anchor" href="#migration-api" aria-hidden="true">#</a></h2><p><code>knex.migrate</code> is the class utilized by the knex migrations cli.</p><p>Each method takes an optional <code>config</code> object, which may specify the following properties:</p><ul><li><code>directory</code>: a relative path to the directory containing the migration files. Can be an array of paths (default <code>./migrations</code>)</li><li><code>extension</code>: the file extension used for the generated migration files (default <code>js</code>)</li><li><code>tableName</code>: the table name used for storing the migration state (default <code>knex_migrations</code>)</li><li><code>schemaName</code>: the schema name used for storing the table with migration state (optional parameter, only works on DBs that support multiple schemas in a single DB, such as PostgreSQL)</li><li><code>disableTransactions</code>: don&#39;t run migrations inside transactions (default <code>false</code>)</li><li><code>disableMigrationsListValidation</code>: do not validate that all the already executed migrations are still present in migration directories (default <code>false</code>)</li><li><code>sortDirsSeparately</code>: if true and multiple directories are specified, all migrations from a single directory will be executed before executing migrations in the next folder (default <code>false</code>)</li><li><code>loadExtensions</code>: array of file extensions which knex will treat as migrations. For example, if you have typescript transpiled into javascript in the same folder, you want to execute only javascript migrations. In this case, set <code>loadExtensions</code> to <code>[&#39;.js&#39;]</code> (Notice the dot!) (default <code>[&#39;.co&#39;, &#39;.coffee&#39;, &#39;.eg&#39;, &#39;.iced&#39;, &#39;.js&#39;, &#39;.litcoffee&#39;, &#39;.ls&#39;, &#39;.ts&#39;]</code>)</li><li><code>migrationSource</code>: specify a custom migration source, see <a href="#custom-migration-sources">Custom Migration Source</a> for more info (default filesystem)</li></ul><h3 id="transactions-in-migrations" tabindex="-1">Transactions in migrations <a class="header-anchor" href="#transactions-in-migrations" aria-hidden="true">#</a></h3><p>By default, each migration is run inside a transaction. Whenever needed, one can disable transactions for all migrations via the common migration config option <code>config.disableTransactions</code> or per-migration, via exposing a boolean property <code>config.transaction</code> from a migration file:</p><div class="language-js"><pre><code>exports<span class="token punctuation">.</span><span class="token function-variable function">up</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">knex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> knex<span class="token punctuation">.</span>schema
    <span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">&#39;users&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      table<span class="token punctuation">.</span><span class="token function">increments</span><span class="token punctuation">(</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      table<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">&#39;first_name&#39;</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notNullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      table<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">&#39;last_name&#39;</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notNullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">&#39;products&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      table<span class="token punctuation">.</span><span class="token function">increments</span><span class="token punctuation">(</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      table<span class="token punctuation">.</span><span class="token function">decimal</span><span class="token punctuation">(</span><span class="token string">&#39;price&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notNullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      table<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notNullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">down</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">knex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> knex<span class="token punctuation">.</span>schema<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">&#39;products&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">&#39;users&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>config <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">transaction</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>The same config property can be used for enabling transaction per-migration in case the common configuration has <code>disableTransactions: true</code>.</p><h3 id="make" tabindex="-1">make <a class="header-anchor" href="#make" aria-hidden="true">#</a></h3><p><strong>knex.migrate.make(name, [config])</strong></p><p>Creates a new migration, with the name of the migration being added.</p><h3 id="latest" tabindex="-1">latest <a class="header-anchor" href="#latest" aria-hidden="true">#</a></h3><p><strong>knex.migrate.latest([config])</strong></p><p>Runs all migrations that have not yet been run.</p><p>If you need to run something only after all migrations have finished their execution, you can do something like this:</p><div class="language-js"><pre><code>knex<span class="token punctuation">.</span>migrate
  <span class="token punctuation">.</span><span class="token function">latest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> knex<span class="token punctuation">.</span>seed<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// migrations are finished</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="rollback" tabindex="-1">rollback <a class="header-anchor" href="#rollback" aria-hidden="true">#</a></h3><p><strong>knex.migrate.rollback([config], [all])</strong></p><p>Rolls back the latest migration group. If the <code>all</code> parameter is truthy, all applied migrations will be rolled back instead of just the last batch. The default value for this parameter is <code>false</code>.</p><h3 id="up" tabindex="-1">up <a class="header-anchor" href="#up" aria-hidden="true">#</a></h3><p><strong>knex.migrate.up([config])</strong></p><p>Runs the specified (by <code>config.name</code> parameter) or the next chronological migration that has not yet be run.</p><h3 id="down" tabindex="-1">down <a class="header-anchor" href="#down" aria-hidden="true">#</a></h3><p><strong>knex.migrate.down([config])</strong></p><p>Will undo the specified (by <code>config.name</code> parameter) or the last migration that was run.</p><h3 id="currentversion" tabindex="-1">currentVersion <a class="header-anchor" href="#currentversion" aria-hidden="true">#</a></h3><p><strong>knex.migrate.currentVersion([config])</strong></p><p>Retrieves and returns the current migration version, as a promise. If there aren&#39;t any migrations run yet, returns &quot;none&quot; as the value for the currentVersion.</p><h3 id="list" tabindex="-1">list <a class="header-anchor" href="#list" aria-hidden="true">#</a></h3><p><strong>knex.migrate.list([config])</strong></p><p>Will return list of completed and pending migrations</p><h3 id="unlock" tabindex="-1">unlock <a class="header-anchor" href="#unlock" aria-hidden="true">#</a></h3><p><strong>knex.migrate.forceFreeMigrationsLock([config])</strong></p><p>Forcibly unlocks the migrations lock table, and ensures that there is only one row in it.</p><h2 id="notes-about-locks" tabindex="-1">Notes about locks <a class="header-anchor" href="#notes-about-locks" aria-hidden="true">#</a></h2><p>A lock system is there to prevent multiple processes from running the same migration batch in the same time. When a batch of migrations is about to be run, the migration system first tries to get a lock using a <code>SELECT ... FOR UPDATE</code> statement (preventing race conditions from happening). If it can get a lock, the migration batch will run. If it can&#39;t, it will wait until the lock is released.</p><p>Please note that if your process unfortunately crashes, the lock will have to be <em>manually</em> removed with <code>knex migrate:unlock</code> in order to let migrations run again.</p><p>The locks are saved in a table called &quot;<code>tableName</code>_lock&quot;; it has a column called <code>is_locked</code> that <code>knex migrate:unlock</code> sets to <code>0</code> in order to release the lock. The <code>index</code> column in the lock table exists for compatibility with some database clusters that require a primary key, but is otherwise unused. There must be only one row in this table, or an error will be thrown when running migrations: &quot;Migration table is already locked&quot;. Run <code>knex migrate:unlock</code> to ensure that there is only one row in the table.</p><h2 id="custom-migration-sources" tabindex="-1">Custom migration sources <a class="header-anchor" href="#custom-migration-sources" aria-hidden="true">#</a></h2><p>Knex supports custom migration sources, allowing you full control of where your migrations come from. This can be useful for custom folder structures, when bundling with webpack/browserify and other scenarios.</p><div class="language-js"><pre><code><span class="token comment">// Create a custom migration source class</span>
<span class="token keyword">class</span> <span class="token class-name">MyMigrationSource</span> <span class="token punctuation">{</span>
  <span class="token comment">// Must return a Promise containing a list of migrations.</span>
  <span class="token comment">// Migrations can be whatever you want,</span>
  <span class="token comment">// they will be passed as arguments to getMigrationName</span>
  <span class="token comment">// and getMigration</span>
  <span class="token function">getMigrations</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// In this example we are just returning migration names</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;migration1&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getMigrationName</span><span class="token punctuation">(</span><span class="token parameter">migration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> migration<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getMigration</span><span class="token punctuation">(</span><span class="token parameter">migration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>migration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">&#39;migration1&#39;</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          <span class="token function">up</span><span class="token punctuation">(</span><span class="token parameter">knex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* ... */</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token function">down</span><span class="token punctuation">(</span><span class="token parameter">knex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* ... */</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// pass an instance of your migration source as knex config</span>
knex<span class="token punctuation">.</span>migrate<span class="token punctuation">.</span><span class="token function">latest</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">migrationSource</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">MyMigrationSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="webpack-migration-source-example" tabindex="-1">Webpack migration source example <a class="header-anchor" href="#webpack-migration-source-example" aria-hidden="true">#</a></h3><p>An example of how to create a migration source where migrations are included in a webpack bundle.</p><div class="language-js"><pre><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">WebpackMigrationSource</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">migrationContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>migrationContext <span class="token operator">=</span> migrationContext<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getMigrations</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>migrationContext<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getMigrationName</span><span class="token punctuation">(</span><span class="token parameter">migration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>migration<span class="token punctuation">)</span><span class="token punctuation">.</span>base<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getMigration</span><span class="token punctuation">(</span><span class="token parameter">migration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">migrationContext</span><span class="token punctuation">(</span>migration<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// pass an instance of your migration source as knex config</span>
knex<span class="token punctuation">.</span>migrate<span class="token punctuation">.</span><span class="token function">latest</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">migrationSource</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">WebpackMigrationSource</span><span class="token punctuation">(</span>
    require<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">&#39;./migrations&#39;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// with webpack &gt;=5, require.context will add</span>
<span class="token comment">// both the relative and absolute paths to the context</span>
<span class="token comment">// to avoid duplicate migration errors, you&#39;ll need</span>
<span class="token comment">// to filter out one or the other this example filters</span>
<span class="token comment">// out absolute paths, leaving only the relative</span>
<span class="token comment">// ones(./migrations/*.js):</span>
knex<span class="token punctuation">.</span>migrate<span class="token punctuation">.</span><span class="token function">latest</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">migrationSource</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">WebpackMigrationSource</span><span class="token punctuation">(</span>
    require<span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">&#39;./migrations&#39;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\.\/.*\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="ecmascript-modules-esm-interoperability" tabindex="-1">ECMAScript modules (ESM) Interoperability <a class="header-anchor" href="#ecmascript-modules-esm-interoperability" aria-hidden="true">#</a></h2><p>ECMAScript Module support for knex CLI&#39;s configuration, migration and seeds<br> enabled by the <code>--esm</code> flag, ECMAScript Interoperability is provided by the <a href="https://github.com/standard-things/esm" target="_blank" rel="noopener noreferrer"><em>&#39;esm&#39;</em></a> module.<br> You can find <a href="https://github.com/standard-things/esm" target="_blank" rel="noopener noreferrer">here</a> more information about &#39;esm&#39; superpowers.</p><p>Node &#39;mjs&#39; files are handled by NodeJS own import mechanics<br> and do not require the use of the &#39;--esm&#39; flag.<br> But you might need it anyway for Node v10 under certain scenarios.<br> You can find details about NodeJS ECMAScript modules <a href="https://nodejs.org/api/esm.html" target="_blank" rel="noopener noreferrer">here</a></p><p>While it is possible to mix and match different module formats (extensions)<br> between your knexfile, seeds and migrations,<br> some format combinations will require specific NodeJS versions,<br><em>Notably mjs/cjs files will follow NodeJS import and require restrictions.</em><br> You can see <a href="https://github.com/knex/knex/blob/master/test/cli/esm-interop.spec.js" target="_blank" rel="noopener noreferrer">here</a> many possible scenarios,<br> and <a href="https://github.com/knex/knex/tree/master/test/jake-util/knexfile-imports" target="_blank" rel="noopener noreferrer">here</a> some sample configurations</p><p>Node v10.* require the use of the &#39;--experimental-module&#39; flag in order to use the &#39;mjs&#39; or &#39;cjs&#39; extension.</p><div class="language-bash"><pre><code><span class="token comment"># launching knex on Node v10 to use mjs/cjs modules</span>
<span class="token function">node</span> --experimental-modules ./node_modules/.bin/knex <span class="token variable">$@</span>
</code></pre></div><p>When using migration and seed files with &#39;.cjs&#39; or &#39;.mjs&#39; extensions, you will need to specify that explicitly:</p><div class="language-ts"><pre><code><span class="token comment">/**
 * knexfile.mjs
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  migrations<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ... client, connection,etc ....</span>
    directory<span class="token operator">:</span> <span class="token string">&#39;./migrations&#39;</span><span class="token punctuation">,</span>
    loadExtensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;.mjs&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>When using &#39;.mjs&#39; extensions for your knexfile and &#39;.js&#39; for the seeds/migrations, you will need to specify that explicitly.</p><div class="language-ts"><pre><code><span class="token comment">/**
 * knexfile.mjs
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  migrations<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ... client, connection,etc ....</span>
    directory<span class="token operator">:</span> <span class="token string">&#39;./migrations&#39;</span><span class="token punctuation">,</span>
    loadExtensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;.js&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// knex will search for &#39;mjs&#39; file by default</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>For the knexfile you can use a default export,<br> it will take precedence over named export.</p><div class="language-ts"><pre><code><span class="token comment">/**
 * filename: knexfile.js
 * For the knexfile you can use a default export
 **/</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  client<span class="token operator">:</span> <span class="token string">&#39;sqlite3&#39;</span><span class="token punctuation">,</span>
  connection<span class="token operator">:</span> <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> <span class="token string">&#39;../test.sqlite3&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  migrations<span class="token operator">:</span> <span class="token punctuation">{</span>
    directory<span class="token operator">:</span> <span class="token string">&#39;./migrations&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  seeds<span class="token operator">:</span> <span class="token punctuation">{</span>
    directory<span class="token operator">:</span> <span class="token string">&#39;./seeds&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * filename: knexfile.js
 * Let knex find the configuration by providing named exports,
 * but if exported a default, it will take precedence, and it will be used instead
 **/</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  client<span class="token operator">:</span> <span class="token string">&#39;sqlite3&#39;</span><span class="token punctuation">,</span>
  connection<span class="token operator">:</span> <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> <span class="token string">&#39;../test.sqlite3&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  migrations<span class="token operator">:</span> <span class="token punctuation">{</span>
    directory<span class="token operator">:</span> <span class="token string">&#39;./migrations&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  seeds<span class="token operator">:</span> <span class="token punctuation">{</span>
    directory<span class="token operator">:</span> <span class="token string">&#39;./seeds&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/** this will be used, it has precedence over named export */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> config<span class="token punctuation">;</span>
<span class="token comment">/** Named exports, will be used if you didn&#39;t provide a default export */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> client<span class="token punctuation">,</span> connection<span class="token punctuation">,</span> migrations<span class="token punctuation">,</span> seeds <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>
</code></pre></div><p>Seed and migration files need to follow Knex conventions</p><div class="language-ts"><pre><code><span class="token comment">// file: seed.js</span>
<span class="token comment">/**
 * Same as with the CommonJS modules
 * You will need to export a &quot;seed&quot; named function.
 * */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">seed</span><span class="token punctuation">(</span>knex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... seed logic here</span>
<span class="token punctuation">}</span>

<span class="token comment">// file: migration.js</span>
<span class="token comment">/**
 * Same as the CommonJS version, the miration file should export
 * &quot;up&quot; and &quot;down&quot; named functions
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">up</span><span class="token punctuation">(</span>knex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... migration logic here</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">down</span><span class="token punctuation">(</span>knex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... migration logic here</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="seed-api" tabindex="-1">Seed API <a class="header-anchor" href="#seed-api" aria-hidden="true">#</a></h2><p><code>knex.seed</code> is the class utilized by the knex seed CLI.</p><p>Each method takes an optional <code>config</code> object, which may specify the following properties:</p><ul><li><code>directory</code>: a relative path to the directory containing the seed files. Can be an array of paths (default <code>./seeds</code>)</li><li><code>loadExtensions</code>: array of file extensions which knex will treat as seeds. For example, if you have typescript transpiled into javascript in the same folder, you want to execute only javascript seeds. In this case, set <code>loadExtensions</code> to <code>[&#39;.js&#39;]</code> (Notice the dot!) (default <code>[&#39;.co&#39;, &#39;.coffee&#39;, &#39;.eg&#39;, &#39;.iced&#39;, &#39;.js&#39;, &#39;.litcoffee&#39;, &#39;.ls&#39;, &#39;.ts&#39;]</code>)</li><li><code>recursive</code>: if true, will find seed files recursively in the directory / directories specified</li><li><code>specific</code>: a specific seed file or an array of seed files to run from the seeds directory, if its value is <code>undefined</code> it will run all the seeds (default <code>undefined</code>). If an array is specified, seed files will be run in the same order as the array</li><li><code>sortDirsSeparately</code>: if true and multiple directories are specified, all seeds from a single directory will be executed before executing seeds in the next folder (default <code>false</code>)</li><li><code>seedSource</code>: specify a custom seed source, see <a href="#custom-seed-sources">Custom Seed Source</a> for more info (default filesystem)</li><li><code>extension</code>: extension to be used for newly generated seeds (default <code>js</code>)</li><li><code>timestampFilenamePrefix</code>: whether timestamp should be added as a prefix for newly generated seeds (default <code>false</code>)</li></ul><h3 id="make-1" tabindex="-1">make <a class="header-anchor" href="#make-1" aria-hidden="true">#</a></h3><p><strong>knex.seed.make(name, [config])</strong></p><p>Creates a new seed file, with the name of the seed file being added. If the seed directory config is an array of paths, the seed file will be generated in the latest specified.</p><h3 id="run" tabindex="-1">run <a class="header-anchor" href="#run" aria-hidden="true">#</a></h3><p><strong>knex.seed.run([config])</strong></p><p>Runs all seed files for the current environment.</p><h2 id="custom-seed-sources" tabindex="-1">Custom seed sources <a class="header-anchor" href="#custom-seed-sources" aria-hidden="true">#</a></h2><p>Knex supports custom seed sources, allowing you full control of where your seeds come from. This can be useful for custom folder structures, when bundling with webpack/browserify and other scenarios.</p><div class="language-js"><pre><code><span class="token comment">// Create a custom seed source class</span>
<span class="token keyword">class</span> <span class="token class-name">MySeedSource</span> <span class="token punctuation">{</span>
  <span class="token comment">// Must return a Promise containing a list of seeds.</span>
  <span class="token comment">// Seeds can be whatever you want, they will be passed as</span>
  <span class="token comment">// arguments to getSeed</span>
  <span class="token function">getSeeds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// In this example we are just returning seed names</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;seed1&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getSeed</span><span class="token punctuation">(</span><span class="token parameter">seed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>seed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">&#39;seed1&#39;</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">knex</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">/* ... */</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// pass an instance of your seed source as knex config</span>
knex<span class="token punctuation">.</span>seed<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">seedSource</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">MySeedSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-07c132fc><div class="edit" data-v-07c132fc><div class="edit-link" data-v-07c132fc data-v-1ed99556><a class="link" href="https://github.com/knex/knex/edit/master/docs/src/guide/migrations.md" target="_blank" rel="noopener noreferrer" data-v-1ed99556>Edit this page on GitHub <svg class="icon outbound icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-1ed99556><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="updated" data-v-07c132fc><!----></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><a class="link" href="/guide/interfaces" data-v-38ede35f><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-38ede35f><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-38ede35f>Interfaces</span></a></div><div class="next" data-v-38ede35f><a class="link" href="/guide/extending" data-v-38ede35f><span class="text" data-v-38ede35f>Extending</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"changelog.md\":\"17672f85\",\"faq_index.md\":\"5b931eb6\",\"faq_recipes.md\":\"9519710b\",\"faq_support.md\":\"3a1bb589\",\"guide_extending.md\":\"fba00f2b\",\"guide_index.md\":\"8af088ee\",\"guide_interfaces.md\":\"69039f37\",\"guide_migrations.md\":\"a3b60bcd\",\"guide_query-builder.md\":\"bcead624\",\"guide_raw.md\":\"82150b7b\",\"guide_ref.md\":\"871a08f0\",\"guide_schema-builder.md\":\"8594d7f3\",\"guide_transactions.md\":\"287f817f\",\"guide_utility.md\":\"36a2823b\",\"index.md\":\"09ca53f9\"}")</script>
    <script type="module" async src="/assets/app.36cb52e5.js"></script>
    
  </body>
</html>